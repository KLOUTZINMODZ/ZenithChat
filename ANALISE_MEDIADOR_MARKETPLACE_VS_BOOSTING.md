# üîç An√°lise Detalhada: Mediador no Marketplace vs Boosting

**Data:** 15/10/2025  
**Problema:** Mediador n√£o encontrado no boosting, mas funciona no marketplace

---

## ‚ùå Erro Atual

```
[BOOSTING] Mediador n√£o encontrado (email: mediador@zenith.com). Taxa n√£o creditada.
```

**Cliente:** ‚úÖ Debitado (escrow)  
**Booster:** ‚úÖ Creditado R$ 285  
**Mediador:** ‚ùå N√ÉO creditado R$ 15

---

## üìä Compara√ß√£o: Marketplace vs Boosting

### **1. Buscar Mediador**

#### **Marketplace (purchasesRoutes.js - linhas 633-641):**
```javascript
let mediatorUser = null;
const envId = process.env.MEDIATOR_USER_ID;
const envEmail = process.env.MEDIATOR_EMAIL;

if (envId) {
  try { 
    mediatorUser = await User.findById(envId).session(session); 
  } catch (_) {}
}

if (!mediatorUser && envEmail) {
  try { 
    mediatorUser = await User.findOne({ email: envEmail }).session(session); 
  } catch (_) {}
}
```

**Estrat√©gia:** Tenta ID primeiro, se falhar tenta email

---

#### **Boosting ATUAL (boostingChatController.js - linhas 728-736):**
```javascript
const mediatorEmail = process.env.MEDIATOR_EMAIL || 'mediador@zenith.com';

try {
  const mediatorUser = await User.findOne({ email: mediatorEmail }).session(session);
  
  if (!mediatorUser) {
    console.warn(`[BOOSTING] Mediador n√£o encontrado (email: ${mediatorEmail}). Taxa n√£o creditada.`);
  }
  // ...
} catch (mediatorError) {
  console.error('[BOOSTING] Erro ao creditar mediador:', mediatorError.message);
}
```

**Estrat√©gia:** Tenta apenas email

---

### **2. Creditar Saldo do Mediador**

#### **Marketplace (purchasesRoutes.js - linhas 643-646):**
```javascript
if (mediatorUser) {
  const medBefore = round2(mediatorUser.walletBalance || 0);
  const medAfter = round2(medBefore + feeAmount);
  mediatorUser.walletBalance = medAfter;
  await mediatorUser.save({ session });
  // ...
}
```

**‚úÖ Atualiza `walletBalance` do usu√°rio**

---

#### **Boosting ATUAL (boostingChatController.js - linhas 738-742):**
```javascript
if (mediatorUser) {
  const mediatorBalanceBefore = round2(mediatorUser.walletBalance || 0);
  const mediatorBalanceAfter = round2(mediatorBalanceBefore + feeAmount);
  mediatorUser.walletBalance = mediatorBalanceAfter;
  await mediatorUser.save({ session });
  // ...
}
```

**‚úÖ Identico ao marketplace**

---

### **3. WalletLedger do Mediador**

#### **Marketplace (purchasesRoutes.js - linhas 647-657):**
```javascript
const created = await WalletLedger.create([{
  userId: mediatorUser._id,
  txId: null,
  direction: 'credit',
  reason: 'purchase_fee',
  amount: feeAmount,
  operationId: `purchase_fee:${purchase._id.toString()}`,
  balanceBefore: medBefore,
  balanceAfter: medAfter,
  metadata: { 
    source: 'purchase', 
    purchaseId: purchase._id.toString(), 
    itemId: purchase.itemId, 
    sellerId: purchase.sellerId, 
    price: Number(purchase.price), 
    feeAmount: feeAmount, 
    sellerReceives: Number(purchase.sellerReceives) 
  }
}], { session });
```

**Reason:** `purchase_fee`  
**Metadata:** purchaseId, itemId, sellerId, price, feeAmount, sellerReceives

---

#### **Boosting ATUAL (boostingChatController.js - linhas 745-767):**
```javascript
const mediatorLedger = await WalletLedger.create([{
  userId: mediatorUser._id,
  txId: null,
  direction: 'credit',
  reason: 'boosting_fee',
  amount: feeAmount,
  operationId: `boosting_fee:${agreement?._id || acceptedProposal?._id}`,
  balanceBefore: mediatorBalanceBefore,
  balanceAfter: mediatorBalanceAfter,
  metadata: {
    source: 'boosting',
    agreementId: agreement?._id?.toString() || null,
    conversationId: conversationId,
    boosterId: boosterUserId?.toString(),
    clientId: clientUserId?.toString(),
    price: Number(price),
    feeAmount: Number(feeAmount),
    boosterReceives: Number(boosterReceives),
    feePercent: 0.05,
    type: 'boosting_service'
  }
}], { session });
```

**Reason:** `boosting_fee`  
**Metadata:** agreementId, conversationId, boosterId, clientId, price, feeAmount, boosterReceives

**‚úÖ Estrutura similar, adaptada para boosting**

---

### **4. Mediator Log (Auditoria)**

#### **Marketplace (purchasesRoutes.js - linhas 660-678):**
```javascript
try {
  const medLedgerDoc = Array.isArray(created) ? created[0] : created;
  await Mediator.create([{
    eventType: 'fee',
    amount: feeAmount,
    currency: 'BRL',
    operationId: `purchase_fee:${purchase._id.toString()}`,
    source: 'ZenithChatApi',
    occurredAt: new Date(),
    reference: {
      purchaseId: purchase._id,
      walletLedgerId: medLedgerDoc?._id || null,
      orderId: null,
      transactionId: null,
      asaasTransferId: null
    },
    metadata: { 
      price: Number(purchase.price), 
      feeAmount: feeAmount, 
      sellerReceives: Number(purchase.sellerReceives), 
      sellerId: purchase.sellerId 
    },
    description: 'Taxa de media√ß√£o (5%) creditada ao mediador'
  }], { session });
} catch (_) {}
```

**Source:** `ZenithChatApi`  
**EventType:** `fee`

---

#### **Boosting ATUAL (boostingChatController.js - linhas 777-805):**
```javascript
try {
  await Mediator.create([{
    eventType: 'fee',
    amount: feeAmount,
    currency: 'BRL',
    operationId: `boosting_fee:${agreement?._id || acceptedProposal?._id}`,
    source: 'ZenithChatApi',
    occurredAt: new Date(),
    reference: {
      agreementId: agreement?._id || null,
      conversationId: conversationId,
      walletLedgerId: mediatorLedger[0]?._id || null,
      transactionId: null,
      asaasTransferId: null
    },
    metadata: {
      price: Number(price),
      feeAmount: Number(feeAmount),
      boosterReceives: Number(boosterReceives),
      boosterId: boosterUserId?.toString(),
      clientId: clientUserId?.toString(),
      feePercent: 0.05,
      serviceType: 'boosting'
    },
    description: 'Taxa de media√ß√£o (5%) creditada ao mediador - Boosting'
  }], { session });
} catch (_) {}
```

**Source:** `ZenithChatApi`  
**EventType:** `fee`

**‚úÖ Identico ao marketplace, mas com campos adaptados**

---

## üî¥ PROBLEMA IDENTIFICADO

### **O c√≥digo est√° CORRETO! O problema √©:**

```
Usu√°rio com email 'mediador@zenith.com' N√ÉO EXISTE no banco de dados!
```

---

## üìã Documento do Mediator que Voc√™ Mostrou

```json
{
  "_id": { "$oid": "68cde2dec2146306d0b2f1f1" },
  "operationId": "release:68cde1ae78d93c19158a74d4",
  "amount": 2.01,
  "eventType": "release",
  "source": "HackloteChatApi",  // ‚Üê NOTA: C√≥digo atual usa "ZenithChatApi"
  "description": "Libera√ß√£o de escrow ao vendedor",
  "reference": {
    "purchaseId": { "$oid": "68cde1ae78d93c19158a74d4" },
    "walletLedgerId": { "$oid": "68cde2d99b0fb52352e0e3fd" }
  }
}
```

**Observa√ß√µes:**
1. ‚úÖ Este √© um log de **`release`** (libera√ß√£o ao vendedor), n√£o `fee`
2. ‚ö†Ô∏è Source: `"HackloteChatApi"` - c√≥digo atual usa `"ZenithChatApi"`
3. ‚úÖ Estrutura correta

---

## ‚ö†Ô∏è Discrep√¢ncia: HackloteChatApi vs ZenithChatApi

### **C√≥digo ATUAL (todos os lugares):**
```javascript
source: 'ZenithChatApi'
```

### **Documento do banco:**
```json
"source": "HackloteChatApi"
```

**Poss√≠veis causas:**
1. O documento √© de uma vers√£o antiga do c√≥digo
2. Existe outro servi√ßo rodando com source diferente
3. O c√≥digo foi atualizado recentemente

**Verificar:** O modelo Mediator aceita ambos?

```javascript
// src/models/Mediator.js
source: { 
  type: String, 
  enum: ['ZenithChatApi', 'ZenithAPI', 'APIAdministrativa', 'Asaas'], 
  required: true 
}
```

‚ùå **"HackloteChatApi" N√ÉO est√° no enum!** Isso pode gerar erro!

---

## ‚úÖ SOLU√á√ÉO

### **1. CR√çTICO: Criar Usu√°rio Mediador**

O usu√°rio `mediador@zenith.com` **N√ÉO EXISTE**. Precisa criar:

#### **Op√ß√£o A: Via MongoDB Shell**
```javascript
db.users.insertOne({
  email: 'mediador@zenith.com',
  name: 'Mediador Zenith',
  username: 'mediador',
  password: '$2b$10$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW', // hash bcrypt de 'admin123'
  role: 'admin',
  walletBalance: 0,
  isActive: true,
  isVerified: true,
  createdAt: new Date(),
  updatedAt: new Date()
})
```

#### **Op√ß√£o B: Usar Usu√°rio Existente**

Se j√° existe um usu√°rio para receber taxas, configure o email no `.env`:

```env
MEDIATOR_EMAIL=email-do-usuario-existente@zenith.com
```

---

### **2. Verificar Source no Modelo**

**Arquivo:** `src/models/Mediator.js`

```javascript
source: { 
  type: String, 
  enum: ['ZenithChatApi', 'ZenithAPI', 'APIAdministrativa', 'Asaas'], 
  required: true 
}
```

**‚úÖ 'ZenithChatApi' est√° no enum** - OK!

Se voc√™ quiser usar 'HackloteChatApi':

```javascript
source: { 
  type: String, 
  enum: ['ZenithChatApi', 'HackloteChatApi', 'ZenithAPI', 'APIAdministrativa', 'Asaas'], 
  required: true 
}
```

---

### **3. Script de Verifica√ß√£o**

Execute o script que criei:

```bash
cd HackloteChatApi
node verificar-mediador.js
```

**O que ele faz:**
1. ‚úÖ Verifica se usu√°rio mediador existe
2. ‚úÖ Lista movimenta√ß√µes do mediador
3. ‚úÖ Compara boosting_fee vs purchase_fee
4. ‚úÖ Mostra saldo atual
5. ‚úÖ Sugere solu√ß√£o se n√£o encontrar

---

## üìä Compara√ß√£o Final: O que DEVE acontecer

### **Marketplace (Compra confirmada):**

```
1. Vendedor recebe 95%
   ‚îî‚îÄ WalletLedger: purchase_release
   ‚îî‚îÄ Mediator: release

2. Mediador recebe 5%
   ‚îî‚îÄ WalletLedger: purchase_fee
   ‚îî‚îÄ Mediator: fee
   ‚îî‚îÄ User.walletBalance += taxa ‚úÖ
```

---

### **Boosting (Entrega confirmada):**

```
1. Booster recebe 95%
   ‚îî‚îÄ WalletLedger: boosting_release
   ‚îî‚îÄ Mediator: release

2. Mediador recebe 5%
   ‚îî‚îÄ WalletLedger: boosting_fee
   ‚îî‚îÄ Mediator: fee
   ‚îî‚îÄ User.walletBalance += taxa ‚úÖ
```

**‚úÖ FLUXO ID√äNTICO!**

---

## üß™ Como Testar

### **1. Criar/Verificar Usu√°rio Mediador**

```javascript
// MongoDB
const mediador = db.users.findOne({ email: 'mediador@zenith.com' })
if (!mediador) {
  console.log('‚ùå Usu√°rio n√£o existe! Criar primeiro!')
} else {
  console.log('‚úÖ Usu√°rio existe:', mediador._id)
}
```

---

### **2. Reiniciar Chat API**

```bash
pm2 restart ZenithChat
pm2 logs ZenithChat --lines 100
```

---

### **3. Confirmar Entrega de Boosting**

Logs esperados:

```
[BOOSTING] Iniciando confirma√ß√£o de entrega...
[BOOSTING] Cliente j√° foi debitado no escrow...
[BOOSTING] Escrow liberado (saldo n√£o alterado)
[BOOSTING] Saldo transferido ao booster: { amount: 285 }
[BOOSTING] Taxa transferida ao mediador: { amount: 15 } ‚úÖ
```

**Sem erro "n√£o encontrado"!**

---

### **4. Verificar WalletLedger**

```javascript
// MongoDB
db.walletledgers.find({
  reason: 'boosting_fee'
}).sort({ createdAt: -1 }).limit(1)

// Deve retornar:
{
  userId: ObjectId('...'), // ID do mediador
  direction: 'credit',
  reason: 'boosting_fee',
  amount: 15,
  balanceBefore: X,
  balanceAfter: X + 15  // ‚úÖ Aumentou!
}
```

---

### **5. Verificar Saldo do Mediador**

```javascript
// MongoDB
db.users.findOne(
  { email: 'mediador@zenith.com' },
  { walletBalance: 1, email: 1 }
)

// Deve retornar:
{
  email: 'mediador@zenith.com',
  walletBalance: XXX  // ‚úÖ Deve ter aumentado R$ 15!
}
```

---

## ‚úÖ Checklist de Solu√ß√£o

### **Verifica√ß√µes:**
- [ ] Usu√°rio mediador existe no banco?
- [ ] Email est√° correto no .env?
- [ ] Source 'ZenithChatApi' est√° no enum do modelo?

### **Testes:**
- [ ] Script verificar-mediador.js executado?
- [ ] Chat API reiniciada?
- [ ] Confirma√ß√£o de entrega testada?
- [ ] WalletLedger criado?
- [ ] Saldo do mediador aumentou?

---

## üéØ CONCLUS√ÉO

### **O c√≥digo do boosting est√° CORRETO e ID√äNTICO ao marketplace!**

**O problema √©:**
```
Usu√°rio com email 'mediador@zenith.com' N√ÉO EXISTE no banco!
```

**Solu√ß√£o:**
1. ‚úÖ Criar usu√°rio mediador
2. ‚úÖ OU configurar email de usu√°rio existente no .env
3. ‚úÖ Reiniciar API
4. ‚úÖ Testar

**Depois disso, tudo funcionar√° perfeitamente!** üéâ

---

**NOTA:** O sistema est√° implementado corretamente. S√≥ falta o usu√°rio mediador existir no banco de dados!

