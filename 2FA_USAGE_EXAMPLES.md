# Exemplos de Uso - Autentica√ß√£o 2FA

## üìù Integra√ß√£o no Fluxo de Login

### 1. Adicionar ao Controller de Login Existente

Modifique seu controller de login para gerar o c√≥digo 2FA ap√≥s validar credenciais:

```javascript
// src/controllers/authController.js
const twoFactorAuthController = require('./twoFactorAuthController');
const emailService = require('../services/emailService'); // Seu servi√ßo de email

exports.login = async (req, res) => {
  try {
    const { email, password } = req.body;
    
    // 1. Validar credenciais
    const user = await User.findOne({ email });
    
    if (!user || !await bcrypt.compare(password, user.password)) {
      return res.status(401).json({
        success: false,
        message: 'Invalid credentials'
      });
    }
    
    // 2. Verificar se usu√°rio est√° banido
    if (user.isBanned()) {
      return res.status(403).json({
        success: false,
        message: 'Account suspended'
      });
    }
    
    // 3. Gerar c√≥digo 2FA
    const { code, tempToken } = await twoFactorAuthController.generate2FACode(user._id);
    
    // 4. Enviar c√≥digo por email
    await emailService.send2FACode(user.email, code, user.name);
    
    // 5. Retornar tempToken para o cliente (n√£o enviar o c√≥digo!)
    return res.status(200).json({
      success: true,
      message: '2FA code sent to your email',
      data: {
        tempToken,
        requiresTwoFactor: true,
        expiresIn: 900 // 15 minutos em segundos
      }
    });
    
  } catch (error) {
    logger.error('Login error:', error);
    return res.status(500).json({
      success: false,
      message: 'Internal server error'
    });
  }
};
```

### 2. Template de Email para C√≥digo 2FA

```javascript
// src/services/emailService.js

exports.send2FACode = async (email, code, userName) => {
  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .code { 
          font-size: 32px; 
          font-weight: bold; 
          color: #007bff; 
          letter-spacing: 4px;
          text-align: center;
          padding: 20px;
          background: #f8f9fa;
          border-radius: 8px;
          margin: 20px 0;
        }
        .warning {
          color: #dc3545;
          font-size: 14px;
          margin-top: 20px;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h2>C√≥digo de Verifica√ß√£o</h2>
        <p>Ol√° ${userName},</p>
        <p>Seu c√≥digo de verifica√ß√£o de dois fatores √©:</p>
        
        <div class="code">${code}</div>
        
        <p>Este c√≥digo expira em <strong>15 minutos</strong>.</p>
        
        <div class="warning">
          ‚ö†Ô∏è <strong>Importante:</strong>
          <ul>
            <li>Nunca compartilhe este c√≥digo com ningu√©m</li>
            <li>Nossa equipe nunca solicitar√° este c√≥digo</li>
            <li>Se voc√™ n√£o solicitou este c√≥digo, ignore este email</li>
          </ul>
        </div>
      </div>
    </body>
    </html>
  `;
  
  return await transporter.sendMail({
    from: process.env.EMAIL_FROM,
    to: email,
    subject: 'Seu c√≥digo de verifica√ß√£o - Zenith',
    html
  });
};
```

## üîÑ Fluxo Completo Frontend ‚Üí Backend

### Frontend (React/Vue/Angular)

```typescript
// 1. Login inicial
async function handleLogin(email: string, password: string) {
  try {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    
    const data = await response.json();
    
    if (data.requiresTwoFactor) {
      // Armazenar tempToken temporariamente
      sessionStorage.setItem('tempToken', data.data.tempToken);
      
      // Redirecionar para p√°gina de verifica√ß√£o 2FA
      router.push('/verify-2fa');
    }
  } catch (error) {
    console.error('Login failed:', error);
  }
}

// 2. Verifica√ß√£o do c√≥digo 2FA
async function handleVerify2FA(code: string) {
  try {
    const tempToken = sessionStorage.getItem('tempToken');
    
    const response = await fetch('/api/auth/verify-2fa-login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, tempToken })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Limpar tempToken
      sessionStorage.removeItem('tempToken');
      
      // Armazenar token de autentica√ß√£o definitivo
      localStorage.setItem('authToken', data.data.token);
      
      // Redirecionar para dashboard
      router.push('/dashboard');
    } else {
      // Mostrar erro e tentativas restantes
      showError(data.message, data.remainingAttempts);
    }
  } catch (error) {
    console.error('2FA verification failed:', error);
  }
}
```

### Componente React de Verifica√ß√£o 2FA

```tsx
import React, { useState, useEffect } from 'react';

function Verify2FAPage() {
  const [code, setCode] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [remainingAttempts, setRemainingAttempts] = useState(null);
  const [timeRemaining, setTimeRemaining] = useState(900); // 15 minutos

  useEffect(() => {
    const timer = setInterval(() => {
      setTimeRemaining(prev => {
        if (prev <= 1) {
          clearInterval(timer);
          return 0;
        }
        return prev - 1;
      });
    }, 1000);

    return () => clearInterval(timer);
  }, []);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const tempToken = sessionStorage.getItem('tempToken');
      
      const response = await fetch('/api/auth/verify-2fa-login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code, tempToken })
      });

      const data = await response.json();

      if (data.success) {
        sessionStorage.removeItem('tempToken');
        localStorage.setItem('authToken', data.data.token);
        window.location.href = '/dashboard';
      } else {
        setError(data.message);
        setRemainingAttempts(data.remainingAttempts);
      }
    } catch (err) {
      setError('Erro ao verificar c√≥digo. Tente novamente.');
    } finally {
      setLoading(false);
    }
  };

  const formatTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  return (
    <div className="verify-2fa-container">
      <h2>Verifica√ß√£o em Duas Etapas</h2>
      <p>Digite o c√≥digo de 6 d√≠gitos enviado para seu email</p>
      
      <form onSubmit={handleSubmit}>
        <input
          type="text"
          value={code}
          onChange={(e) => setCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
          placeholder="000000"
          maxLength={6}
          pattern="\d{6}"
          required
          disabled={loading || timeRemaining === 0}
        />
        
        {error && (
          <div className="error">
            {error}
            {remainingAttempts !== null && (
              <span> ({remainingAttempts} tentativas restantes)</span>
            )}
          </div>
        )}
        
        <div className="timer">
          C√≥digo expira em: <strong>{formatTime(timeRemaining)}</strong>
        </div>
        
        <button 
          type="submit" 
          disabled={loading || code.length !== 6 || timeRemaining === 0}
        >
          {loading ? 'Verificando...' : 'Verificar C√≥digo'}
        </button>
      </form>
      
      {timeRemaining === 0 && (
        <div className="expired">
          C√≥digo expirado. Por favor, fa√ßa login novamente.
        </div>
      )}
    </div>
  );
}

export default Verify2FAPage;
```

## üß™ Testes com cURL

### 1. Login (gerar c√≥digo 2FA)
```bash
curl -X POST https://zenithggapi.vercel.app/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123"
  }'

# Resposta esperada:
# {
#   "success": true,
#   "message": "2FA code sent to your email",
#   "data": {
#     "tempToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
#     "requiresTwoFactor": true,
#     "expiresIn": 900
#   }
# }
```

### 2. Verificar c√≥digo 2FA
```bash
curl -X POST https://zenithggapi.vercel.app/api/auth/verify-2fa-login \
  -H "Content-Type: application/json" \
  -d '{
    "code": "123456",
    "tempToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }'

# Resposta de sucesso:
# {
#   "success": true,
#   "message": "Authentication successful",
#   "data": {
#     "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
#     "user": {
#       "id": "userId",
#       "name": "User Name",
#       "email": "user@example.com",
#       "avatar": "avatar_url"
#     }
#   }
# }

# Resposta de erro (c√≥digo inv√°lido):
# {
#   "success": false,
#   "message": "Invalid verification code",
#   "remainingAttempts": 3
# }

# Resposta de erro (bloqueado):
# {
#   "success": false,
#   "message": "Too many attempts. Try again in 14 minutes"
# }

# Resposta de erro (rate limit):
# {
#   "success": false,
#   "message": "Too many verification attempts. Please try again in 5 minutes.",
#   "retryAfter": 287
# }
```

## üîß Utilit√°rios para Desenvolvimento

### Invalidar c√≥digos de um usu√°rio (√∫til para testes)
```javascript
// Script de teste: scripts/invalidate-2fa.js
const mongoose = require('mongoose');
const twoFactorAuthController = require('../src/controllers/twoFactorAuthController');

async function invalidateUserCodes(userId) {
  await mongoose.connect(process.env.MONGODB_URI);
  await twoFactorAuthController.invalidateUserCodes(userId);
  console.log('C√≥digos 2FA invalidados com sucesso');
  process.exit(0);
}

// Executar: node scripts/invalidate-2fa.js USER_ID
invalidateUserCodes(process.argv[2]);
```

### Limpar registros 2FA antigos (manuten√ß√£o)
```javascript
// Script de limpeza: scripts/cleanup-2fa.js
const mongoose = require('mongoose');
const TwoFactorAuth = require('../src/models/TwoFactorAuth');

async function cleanup() {
  await mongoose.connect(process.env.MONGODB_URI);
  
  // Remover registros expirados h√° mais de 1 dia
  const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
  
  const result = await TwoFactorAuth.deleteMany({
    expiresAt: { $lt: oneDayAgo }
  });
  
  console.log(`${result.deletedCount} registros 2FA antigos removidos`);
  process.exit(0);
}

cleanup();
```

## üìä Monitoramento

### Query para detectar poss√≠veis ataques
```javascript
// scripts/detect-bruteforce.js
const TwoFactorAuth = require('../src/models/TwoFactorAuth');

async function detectBruteforce() {
  const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
  
  // Agrupar por IP com muitas tentativas
  const suspiciousIPs = await TwoFactorAuth.aggregate([
    { $match: { createdAt: { $gte: fiveMinutesAgo } } },
    { $group: {
      _id: '$ipAddress',
      attempts: { $sum: '$attempts' },
      count: { $sum: 1 }
    }},
    { $match: { $or: [
      { attempts: { $gte: 10 } },
      { count: { $gte: 5 } }
    ]}},
    { $sort: { attempts: -1 } }
  ]);
  
  if (suspiciousIPs.length > 0) {
    console.log('‚ö†Ô∏è IPs suspeitos detectados:');
    console.table(suspiciousIPs);
  } else {
    console.log('‚úÖ Nenhuma atividade suspeita detectada');
  }
}

setInterval(detectBruteforce, 5 * 60 * 1000); // Executar a cada 5 minutos
```

## üéØ Boas Pr√°ticas

1. **Nunca** armazene o c√≥digo 2FA em localStorage/sessionStorage
2. **Sempre** use HTTPS em produ√ß√£o
3. **Implemente** notifica√ß√µes de login para usu√°rios
4. **Considere** adicionar device fingerprinting
5. **Monitore** tentativas de login suspeitas
6. **Configure** alertas para bloqueios frequentes
7. **Revise** logs de seguran√ßa periodicamente
8. **Teste** regularmente o fluxo completo

## üìö Recursos Adicionais

- [Documenta√ß√£o de Seguran√ßa](./2FA_SECURITY_DOCUMENTATION.md)
- [C√≥digo do Controller](./src/controllers/twoFactorAuthController.js)
- [C√≥digo do Modelo](./src/models/TwoFactorAuth.js)
- [Rotas](./src/routes/authRoutes.js)
