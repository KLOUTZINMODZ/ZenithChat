const routeCache = require('../services/RouteAwareConversationCache');
const logger = require('../utils/logger');

/**
 * Middleware para rastrear rotas dos usu치rios
 * Registra quando usu치rios entram/saem de rotas relacionadas ao chat
 */
const routeTrackingMiddleware = (req, res, next) => {
  try {
    // S칩 rastrear se usu치rio estiver autenticado
    if (req.user && req.user.id) {
      const userId = req.user.id;
      const route = req.originalUrl || req.url;
      
      // Registrar rota atual do usu치rio
      routeCache.setUserRoute(userId, route);
      
      // Log apenas para rotas importantes
      if (routeCache.isChatRoute(route)) {
        logger.debug(`游녻 User ${userId} entered chat route: ${route}`);
      }
    }
    
    next();
  } catch (error) {
    logger.error('Error in route tracking middleware:', error);
    next(); // Continuar mesmo com erro para n칚o quebrar a aplica칞칚o
  }
};

/**
 * Middleware espec칤fico para WebSocket connections
 * Registra quando usu치rio se conecta via WebSocket
 */
const websocketRouteTracker = (userId, route = '/ws') => {
  try {
    routeCache.setUserRoute(userId, route);
    logger.debug(`游댋 WebSocket user ${userId} connected to: ${route}`);
  } catch (error) {
    logger.error('Error tracking WebSocket route:', error);
  }
};

/**
 * Fun칞칚o para notificar quando usu치rio sai da aplica칞칚o
 */
const trackUserDisconnect = (userId) => {
  try {
    routeCache.setUserRoute(userId, '/offline');
    logger.debug(`游녦 User ${userId} disconnected`);
  } catch (error) {
    logger.error('Error tracking user disconnect:', error);
  }
};

module.exports = {
  routeTrackingMiddleware,
  websocketRouteTracker,
  trackUserDisconnect
};
