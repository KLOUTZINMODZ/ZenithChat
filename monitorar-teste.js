require('dotenv').config();
const mongoose = require('mongoose');

let initialState = null;

async function capturarEstadoInicial() {
  try {
    console.log('üîç Capturando estado INICIAL do sistema...\n');
    await mongoose.connect(process.env.MONGODB_URI);

    const User = require('./src/models/User');
    const WalletLedger = require('./src/models/WalletLedger');
    const Mediator = require('./src/models/Mediator');

    const mediatorEmail = process.env.MEDIATOR_EMAIL || 'klouts69@gmail.com';
    const mediatorUser = await User.findOne({ email: mediatorEmail });

    if (!mediatorUser) {
      console.log('‚ùå Mediador n√£o encontrado!');
      console.log(`   Email buscado: ${mediatorEmail}`);
      process.exit(1);
    }

    const boostingFees = await WalletLedger.countDocuments({
      userId: mediatorUser._id,
      reason: 'boosting_fee'
    });

    const mediatorDocs = await Mediator.countDocuments({});

    initialState = {
      mediatorId: mediatorUser._id.toString(),
      mediatorEmail: mediatorUser.email,
      mediatorName: mediatorUser.name,
      saldoInicial: mediatorUser.walletBalance || 0,
      boostingFeesInicial: boostingFees,
      mediatorDocsInicial: mediatorDocs
    };

    console.log('üìä ESTADO INICIAL:');
    console.log('================================================================================');
    console.log('');
    console.log('üë§ MEDIADOR:');
    console.log(`   ID: ${initialState.mediatorId}`);
    console.log(`   Email: ${initialState.mediatorEmail}`);
    console.log(`   Nome: ${initialState.mediatorName}`);
    console.log(`   Saldo: R$ ${initialState.saldoInicial.toFixed(2)}`);
    console.log('');
    console.log('üìä ESTAT√çSTICAS:');
    console.log(`   WalletLedgers (boosting_fee): ${initialState.boostingFeesInicial}`);
    console.log(`   Documentos na collection Mediator: ${initialState.mediatorDocsInicial}`);
    console.log('');
    console.log('================================================================================');
    console.log('');
    console.log('‚è≥ AGUARDANDO CONFIRMA√á√ÉO DE ENTREGA...');
    console.log('   (Confirme a entrega no painel agora)');
    console.log('');
    console.log('   Pressione CTRL+C quando terminar o teste');
    console.log('');

    // Salvar estado em arquivo
    const fs = require('fs');
    fs.writeFileSync('./.teste-state.json', JSON.stringify(initialState, null, 2));

    return initialState;

  } catch (error) {
    console.error('‚ùå Erro:', error.message);
    process.exit(1);
  }
}

async function verificarEstadoFinal() {
  try {
    console.log('\nüîç Capturando estado FINAL do sistema...\n');

    const User = require('./src/models/User');
    const WalletLedger = require('./src/models/WalletLedger');
    const Mediator = require('./src/models/Mediator');

    const mediatorUser = await User.findById(initialState.mediatorId);

    if (!mediatorUser) {
      console.log('‚ùå Mediador n√£o encontrado!');
      return;
    }

    const boostingFees = await WalletLedger.countDocuments({
      userId: mediatorUser._id,
      reason: 'boosting_fee'
    });

    const mediatorDocs = await Mediator.countDocuments({});

    const finalState = {
      saldoFinal: mediatorUser.walletBalance || 0,
      boostingFeesFinal: boostingFees,
      mediatorDocsFinal: mediatorDocs
    };

    console.log('üìä ESTADO FINAL:');
    console.log('================================================================================');
    console.log('');
    console.log('üë§ MEDIADOR:');
    console.log(`   Saldo: R$ ${finalState.saldoFinal.toFixed(2)}`);
    console.log('');
    console.log('üìä ESTAT√çSTICAS:');
    console.log(`   WalletLedgers (boosting_fee): ${finalState.boostingFeesFinal}`);
    console.log(`   Documentos na collection Mediator: ${finalState.mediatorDocsFinal}`);
    console.log('');
    console.log('================================================================================');
    console.log('');

    // Compara√ß√£o
    const saldoDiff = finalState.saldoFinal - initialState.saldoInicial;
    const feesDiff = finalState.boostingFeesFinal - initialState.boostingFeesInicial;
    const docsDiff = finalState.mediatorDocsFinal - initialState.mediatorDocsInicial;

    console.log('üìà COMPARA√á√ÉO (Antes ‚Üí Depois):');
    console.log('================================================================================');
    console.log('');
    console.log(`   Saldo do mediador:`);
    console.log(`      Antes:  R$ ${initialState.saldoInicial.toFixed(2)}`);
    console.log(`      Depois: R$ ${finalState.saldoFinal.toFixed(2)}`);
    console.log(`      ${saldoDiff > 0 ? '‚úÖ' : '‚ùå'} Diferen√ßa: ${saldoDiff >= 0 ? '+' : ''}R$ ${saldoDiff.toFixed(2)} ${saldoDiff === 15 ? '(CORRETO!)' : saldoDiff > 0 ? '(Valor diferente do esperado)' : '(N√ÉO MUDOU!)'}`);
    console.log('');
    console.log(`   WalletLedgers (boosting_fee):`);
    console.log(`      Antes:  ${initialState.boostingFeesInicial}`);
    console.log(`      Depois: ${finalState.boostingFeesFinal}`);
    console.log(`      ${feesDiff > 0 ? '‚úÖ' : '‚ùå'} Diferen√ßa: ${feesDiff >= 0 ? '+' : ''}${feesDiff} ${feesDiff > 0 ? '(OK!)' : '(N√ÉO MUDOU!)'}`);
    console.log('');
    console.log(`   Collection Mediator:`);
    console.log(`      Antes:  ${initialState.mediatorDocsInicial}`);
    console.log(`      Depois: ${finalState.mediatorDocsFinal}`);
    console.log(`      ${docsDiff >= 2 ? '‚úÖ' : '‚ùå'} Diferen√ßa: ${docsDiff >= 0 ? '+' : ''}${docsDiff} ${docsDiff >= 2 ? '(OK! release + fee)' : docsDiff > 0 ? '(Incompleto)' : '(N√ÉO MUDOU!)'}`);
    console.log('');
    console.log('================================================================================');
    console.log('');

    // Resultado final
    const passou = saldoDiff === 15 && feesDiff > 0 && docsDiff >= 2;

    if (passou) {
      console.log('üéâ TESTE PASSOU! ‚úÖ');
      console.log('');
      console.log('   ‚úÖ Saldo do mediador aumentou R$ 15,00');
      console.log('   ‚úÖ WalletLedger criado com boosting_fee');
      console.log('   ‚úÖ Collection Mediator registrou os eventos');
      console.log('');
      console.log('   üöÄ SISTEMA FUNCIONANDO PERFEITAMENTE!');
      console.log('');
      console.log('   üìã Pr√≥ximos passos:');
      console.log('      1. Testar tamb√©m o marketplace');
      console.log('      2. Verificar painel administrativo');
      console.log('      3. Monitorar pr√≥ximas confirma√ß√µes');
    } else {
      console.log('‚ùå TESTE FALHOU!');
      console.log('');
      if (saldoDiff !== 15) {
        console.log(`   ‚ùå Saldo do mediador ${saldoDiff === 0 ? 'N√ÉO mudou' : 'mudou valor incorreto'}`);
        console.log(`      Esperado: +R$ 15,00`);
        console.log(`      Recebido: ${saldoDiff >= 0 ? '+' : ''}R$ ${saldoDiff.toFixed(2)}`);
      }
      if (feesDiff === 0) {
        console.log('   ‚ùå WalletLedger (boosting_fee) N√ÉO foi criado');
      }
      if (docsDiff < 2) {
        console.log('   ‚ùå Collection Mediator n√£o registrou todos os eventos');
        console.log(`      Esperado: +2 (release + fee)`);
        console.log(`      Recebido: +${docsDiff}`);
      }
      console.log('');
      console.log('   üîç Verificar logs do pm2:');
      console.log('      pm2 logs ZenithChat --lines 100');
    }

    console.log('');
    console.log('================================================================================');
    console.log('‚úÖ Monitoramento conclu√≠do!\n');

  } catch (error) {
    console.error('‚ùå Erro:', error.message);
  } finally {
    await mongoose.disconnect();
    process.exit(0);
  }
}

// Executar
(async () => {
  await capturarEstadoInicial();

  // Aguardar 5 minutos antes de verificar estado final
  // (ou usu√°rio pode pressionar CTRL+C e rodar novamente)
  setTimeout(async () => {
    await verificarEstadoFinal();
  }, 300000); // 5 minutos

  // Permitir verifica√ß√£o manual
  process.on('SIGINT', async () => {
    console.log('\n\n‚è∏Ô∏è  Interrompido pelo usu√°rio. Verificando estado final...\n');
    await verificarEstadoFinal();
  });
})();
