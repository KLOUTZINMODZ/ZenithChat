require('dotenv').config();
const mongoose = require('mongoose');

async function verificarMediador() {
  try {
    console.log('üîç Conectando ao MongoDB...');
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('‚úÖ Conectado!\n');

    const User = require('./src/models/User');
    const WalletLedger = require('./src/models/WalletLedger');
    const Mediator = require('./src/models/Mediator');

    // 1. Verificar vari√°veis de ambiente
    console.log('üìã VARI√ÅVEIS DE AMBIENTE:');
    console.log('  MEDIATOR_USER_ID:', process.env.MEDIATOR_USER_ID || '‚ùå N√ÉO CONFIGURADO');
    console.log('  MEDIATOR_EMAIL:', process.env.MEDIATOR_EMAIL || '‚ùå N√ÉO CONFIGURADO');
    console.log('  Fallback email:', 'mediador@zenith.com');
    console.log('');

    // 2. Buscar usu√°rio mediador
    const mediatorEmail = process.env.MEDIATOR_EMAIL || 'mediador@zenith.com';
    console.log(`üîç Buscando usu√°rio com email: ${mediatorEmail}`);
    
    const mediatorUser = await User.findOne({ email: mediatorEmail });
    
    if (!mediatorUser) {
      console.log('‚ùå USU√ÅRIO MEDIADOR N√ÉO ENCONTRADO!');
      console.log('');
      
      // Listar usu√°rios com emails similares
      console.log('üìã Buscando usu√°rios com emails similares...');
      const similarUsers = await User.find({ 
        email: { $regex: 'mediador', $options: 'i' } 
      }, { email: 1, name: 1, _id: 1, walletBalance: 1 }).limit(5);
      
      if (similarUsers.length > 0) {
        console.log('Encontrados:', similarUsers.length);
        similarUsers.forEach(u => {
          console.log(`  - ID: ${u._id}`);
          console.log(`    Email: ${u.email}`);
          console.log(`    Nome: ${u.name}`);
          console.log(`    Saldo: R$ ${(u.walletBalance || 0).toFixed(2)}`);
          console.log('');
        });
      } else {
        console.log('‚ùå Nenhum usu√°rio encontrado com "mediador" no email');
        console.log('');
        
        // Listar primeiros 10 usu√°rios do banco
        console.log('üìã Listando primeiros 10 usu√°rios do banco:');
        const allUsers = await User.find({}, { email: 1, name: 1, _id: 1, role: 1 }).limit(10);
        allUsers.forEach(u => {
          console.log(`  - ${u.email} (${u.name}) - Role: ${u.role || 'N/A'}`);
        });
      }
      
      console.log('');
      console.log('üí° SOLU√á√ÉO:');
      console.log('  1. Criar usu√°rio mediador no banco:');
      console.log(`     db.users.insertOne({`);
      console.log(`       email: "${mediatorEmail}",`);
      console.log(`       name: "Mediador Zenith",`);
      console.log(`       username: "mediador",`);
      console.log(`       password: "$2b$10$hash...",`);
      console.log(`       role: "admin",`);
      console.log(`       walletBalance: 0,`);
      console.log(`       isActive: true,`);
      console.log(`       createdAt: new Date(),`);
      console.log(`       updatedAt: new Date()`);
      console.log(`     })`);
      console.log('');
      console.log('  2. OU atualizar MEDIATOR_EMAIL no .env com email de usu√°rio existente');
      
    } else {
      console.log('‚úÖ USU√ÅRIO MEDIADOR ENCONTRADO!');
      console.log('  ID:', mediatorUser._id);
      console.log('  Email:', mediatorUser.email);
      console.log('  Nome:', mediatorUser.name);
      console.log('  Saldo:', `R$ ${(mediatorUser.walletBalance || 0).toFixed(2)}`);
      console.log('  Role:', mediatorUser.role || 'N/A');
      console.log('  Ativo:', mediatorUser.isActive || false);
      console.log('');

      // 3. Verificar movimenta√ß√µes do mediador
      console.log('üìä MOVIMENTA√á√ïES DO MEDIADOR (WalletLedger):');
      const ledgers = await WalletLedger.find({ 
        userId: mediatorUser._id 
      }).sort({ createdAt: -1 }).limit(5);
      
      console.log(`  Total encontrado: ${ledgers.length}`);
      if (ledgers.length > 0) {
        ledgers.forEach(l => {
          console.log(`  - ${l.createdAt.toISOString().split('T')[0]} | ${l.reason} | ${l.direction} | R$ ${l.amount.toFixed(2)}`);
        });
      } else {
        console.log('  ‚ö†Ô∏è Nenhuma movimenta√ß√£o encontrada');
      }
      console.log('');

      // 4. Verificar logs do Mediator
      console.log('üìä LOGS DO MEDIATOR (Auditoria):');
      const mediatorLogs = await Mediator.find({}).sort({ occurredAt: -1 }).limit(5);
      
      console.log(`  Total encontrado: ${mediatorLogs.length}`);
      if (mediatorLogs.length > 0) {
        mediatorLogs.forEach(m => {
          console.log(`  - ${m.occurredAt.toISOString().split('T')[0]} | ${m.eventType} | ${m.source} | R$ ${m.amount.toFixed(2)}`);
        });
      } else {
        console.log('  ‚ö†Ô∏è Nenhum log encontrado');
      }
      console.log('');

      // 5. Verificar boosting_fee especificamente
      console.log('üéÆ TAXAS DE BOOSTING (boosting_fee):');
      const boostingFees = await WalletLedger.find({ 
        reason: 'boosting_fee'
      }).sort({ createdAt: -1 }).limit(3);
      
      console.log(`  Total encontrado: ${boostingFees.length}`);
      if (boostingFees.length > 0) {
        boostingFees.forEach(l => {
          console.log(`  - ${l.createdAt.toISOString()} | User: ${l.userId} | R$ ${l.amount.toFixed(2)}`);
        });
      } else {
        console.log('  ‚ö†Ô∏è Nenhuma taxa de boosting encontrada');
      }
      console.log('');

      // 6. Comparar com purchase_fee
      console.log('üõí TAXAS DE MARKETPLACE (purchase_fee):');
      const purchaseFees = await WalletLedger.find({ 
        reason: 'purchase_fee'
      }).sort({ createdAt: -1 }).limit(3);
      
      console.log(`  Total encontrado: ${purchaseFees.length}`);
      if (purchaseFees.length > 0) {
        purchaseFees.forEach(l => {
          console.log(`  - ${l.createdAt.toISOString()} | User: ${l.userId} | R$ ${l.amount.toFixed(2)}`);
        });
      } else {
        console.log('  ‚ö†Ô∏è Nenhuma taxa de marketplace encontrada');
      }
    }

    console.log('');
    console.log('‚úÖ Verifica√ß√£o conclu√≠da!');
    
  } catch (error) {
    console.error('‚ùå Erro:', error.message);
  } finally {
    await mongoose.disconnect();
    process.exit(0);
  }
}

verificarMediador();
