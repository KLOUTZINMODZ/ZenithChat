#!/usr/bin/env node
/**
 * Script para verificar se o usu√°rio mediador existe no banco de dados
 * 
 * Uso: node verificar-mediador.js
 */

require('dotenv').config();
const mongoose = require('mongoose');
const User = require('./src/models/User');

const MONGODB_URI = process.env.MONGODB_URI;
const MEDIATOR_USER_ID = process.env.MEDIATOR_USER_ID;
const MEDIATOR_EMAIL = process.env.MEDIATOR_EMAIL;

async function verificarMediator() {
  try {
    console.log('üîç Conectando ao MongoDB...');
    await mongoose.connect(MONGODB_URI);
    console.log('‚úÖ Conectado ao MongoDB\n');

    console.log('üìã Configura√ß√µes do .env:');
    console.log('  MEDIATOR_USER_ID:', MEDIATOR_USER_ID || '(n√£o configurado)');
    console.log('  MEDIATOR_EMAIL:', MEDIATOR_EMAIL || '(n√£o configurado)');
    console.log('');

    let mediadorEncontrado = null;

    // 1. Tentar buscar por ID
    if (MEDIATOR_USER_ID) {
      console.log('üîç Buscando mediador por ID...');
      try {
        mediadorEncontrado = await User.findById(MEDIATOR_USER_ID);
        if (mediadorEncontrado) {
          console.log('‚úÖ Mediador encontrado por ID!');
          console.log('  _id:', mediadorEncontrado._id);
          console.log('  email:', mediadorEncontrado.email);
          console.log('  name:', mediadorEncontrado.name);
          console.log('  walletBalance:', mediadorEncontrado.walletBalance);
          console.log('');
        } else {
          console.log('‚ùå Mediador N√ÉO encontrado por ID:', MEDIATOR_USER_ID);
          console.log('');
        }
      } catch (err) {
        console.error('‚ùå Erro ao buscar por ID:', err.message);
        console.log('');
      }
    }

    // 2. Tentar buscar por email
    if (!mediadorEncontrado && MEDIATOR_EMAIL) {
      console.log('üîç Buscando mediador por email...');
      try {
        mediadorEncontrado = await User.findOne({ email: MEDIATOR_EMAIL });
        if (mediadorEncontrado) {
          console.log('‚úÖ Mediador encontrado por email!');
          console.log('  _id:', mediadorEncontrado._id);
          console.log('  email:', mediadorEncontrado.email);
          console.log('  name:', mediadorEncontrado.name);
          console.log('  walletBalance:', mediadorEncontrado.walletBalance);
          console.log('');
        } else {
          console.log('‚ùå Mediador N√ÉO encontrado por email:', MEDIATOR_EMAIL);
          console.log('');
        }
      } catch (err) {
        console.error('‚ùå Erro ao buscar por email:', err.message);
        console.log('');
      }
    }

    // 3. Resultado final
    if (mediadorEncontrado) {
      console.log('‚úÖ RESULTADO: Mediador CONFIGURADO CORRETAMENTE!');
      console.log('');
      console.log('üìä Dados do Mediador:');
      console.log('  ID:', mediadorEncontrado._id.toString());
      console.log('  Email:', mediadorEncontrado.email);
      console.log('  Nome:', mediadorEncontrado.name);
      console.log('  Saldo Atual:', `R$ ${(mediadorEncontrado.walletBalance || 0).toFixed(2)}`);
      console.log('');
      console.log('‚úÖ O sistema de boosting deve funcionar corretamente!');
      console.log('');
      
      // Sugest√£o de atualiza√ß√£o do .env
      if (MEDIATOR_USER_ID !== mediadorEncontrado._id.toString()) {
        console.log('‚ö†Ô∏è ATEN√á√ÉO: O ID no .env est√° diferente do banco!');
        console.log('');
        console.log('üìù Atualize o .env para:');
        console.log(`MEDIATOR_USER_ID=${mediadorEncontrado._id.toString()}`);
        console.log(`MEDIATOR_EMAIL=${mediadorEncontrado.email}`);
        console.log('');
      }
    } else {
      console.log('‚ùå RESULTADO: Mediador N√ÉO ENCONTRADO!');
      console.log('');
      console.log('üö® A√á√ÉO NECESS√ÅRIA: Criar usu√°rio mediador no banco de dados');
      console.log('');
      console.log('üìù Op√ß√µes:');
      console.log('');
      console.log('1. Criar via MongoDB Shell:');
      console.log('```javascript');
      console.log('db.users.insertOne({');
      console.log('  email: "mediador@zenith.com",');
      console.log('  name: "Mediador Zenith",');
      console.log('  username: "mediador",');
      console.log('  password: "$2b$10$...",  // Hash bcrypt');
      console.log('  role: "admin",');
      console.log('  walletBalance: 0,');
      console.log('  isActive: true,');
      console.log('  isVerified: true,');
      console.log('  createdAt: new Date(),');
      console.log('  updatedAt: new Date()');
      console.log('});');
      console.log('```');
      console.log('');
      console.log('2. Usar um usu√°rio admin existente:');
      console.log('   - Busque um usu√°rio admin no banco');
      console.log('   - Configure o ID dele no .env como MEDIATOR_USER_ID');
      console.log('');
      console.log('3. Criar via painel administrativo (se dispon√≠vel)');
      console.log('');
    }

  } catch (error) {
    console.error('‚ùå Erro:', error.message);
  } finally {
    await mongoose.connection.close();
    console.log('üîå Desconectado do MongoDB');
  }
}

// Executar
verificarMediator();
