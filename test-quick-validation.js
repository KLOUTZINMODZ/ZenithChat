const mongoose = require('mongoose');
const Conversation = require('./src/models/Conversation');
const Agreement = require('./src/models/Agreement');
const AcceptedProposal = require('./src/models/AcceptedProposal');

async function validateSystems() {
  try {
    console.log('üß™ Valida√ß√£o R√°pida dos Sistemas Implementados\n');


    await mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/hacklote_chat');
    

    console.log('1Ô∏è‚É£ Sistema de Bloqueio por Report:');
    const conversationSchema = Conversation.schema;
    const hasIsReported = conversationSchema.paths.isReported;
    console.log(`   ‚úÖ Campo 'isReported' ${hasIsReported ? 'PRESENTE' : 'AUSENTE'} no schema`);
    
    if (hasIsReported) {
      console.log(`   ‚úÖ Tipo: ${hasIsReported.instance}, Default: ${hasIsReported.defaultValue}, Index: ${hasIsReported._index || false}`);
    }
    

    console.log('\n2Ô∏è‚É£ Sistema Agreement (M√∫ltiplas Propostas):');
    const agreementSchema = Agreement.schema;
    const hasAgreementId = agreementSchema.paths.agreementId;
    const hasVersion = agreementSchema.paths.version;
    const hasActionHistory = agreementSchema.paths.actionHistory;
    
    console.log(`   ‚úÖ Campo 'agreementId' ${hasAgreementId ? 'PRESENTE' : 'AUSENTE'}`);
    console.log(`   ‚úÖ Campo 'version' ${hasVersion ? 'PRESENTE' : 'AUSENTE'} (optimistic locking)`);
    console.log(`   ‚úÖ Campo 'actionHistory' ${hasActionHistory ? 'PRESENTE' : 'AUSENTE'} (idempot√™ncia)`);
    

    console.log('\n3Ô∏è‚É£ Constraint AcceptedProposal:');
    const acceptedProposalSchema = AcceptedProposal.schema;
    const conversationIdField = acceptedProposalSchema.paths.conversationId;
    const isUnique = conversationIdField._index?.unique;
    
    console.log(`   ${isUnique ? '‚ùå' : '‚úÖ'} conversationId unique: ${isUnique ? 'AINDA PRESENTE (PROBLEMA!)' : 'REMOVIDO (CORRETO)'}`);
    

    console.log('\n4Ô∏è‚É£ M√©todos Agreement:');
    const agreementInstance = new Agreement();
    console.log(`   ‚úÖ complete() ${typeof agreementInstance.complete === 'function' ? 'PRESENTE' : 'AUSENTE'}`);
    console.log(`   ‚úÖ cancel() ${typeof agreementInstance.cancel === 'function' ? 'PRESENTE' : 'AUSENTE'}`);
    console.log(`   ‚úÖ addAction() ${typeof agreementInstance.addAction === 'function' ? 'PRESENTE' : 'AUSENTE'}`);
    

    console.log('\n5Ô∏è‚É£ Estado Atual da Database:');
    const conversationCount = await Conversation.countDocuments({});
    const acceptedProposalCount = await AcceptedProposal.countDocuments({});
    const agreementCount = await Agreement.countDocuments({});
    const reportedChatsCount = await Conversation.countDocuments({ isReported: true });
    
    console.log(`   üìä Conversas total: ${conversationCount}`);
    console.log(`   üìä Chats reportados: ${reportedChatsCount}`);
    console.log(`   üìä AcceptedProposals: ${acceptedProposalCount}`);
    console.log(`   üìä Agreements: ${agreementCount}`);
    

    console.log('\n6Ô∏è‚É£ Teste de Cria√ß√£o Agreement:');
    const testAgreement = new Agreement({
      conversationId: new mongoose.Types.ObjectId(),
      proposalId: new mongoose.Types.ObjectId(),
      proposalSnapshot: {
        game: 'League of Legends',
        category: 'Test',
        description: 'Teste de valida√ß√£o',
        price: 100,
        estimatedTime: '1 hora'
      },
      parties: {
        client: {
          userid: new mongoose.Types.ObjectId(),
          name: 'Teste Cliente'
        },
        booster: {
          userid: new mongoose.Types.ObjectId(),
          name: 'Teste Booster',
          rating: 5
        }
      },
      status: 'active'
    });
    
    const agreementIdGenerated = testAgreement.agreementId;
    console.log(`   ‚úÖ Agreement ID auto-gerado: ${agreementIdGenerated ? 'SIM' : 'N√ÉO'}`);
    if (agreementIdGenerated) {
      console.log(`   üìù Formato: ${agreementIdGenerated} (${agreementIdGenerated.startsWith('AGR_') ? 'CORRETO' : 'INCORRETO'})`);
    }
    
    console.log('\nüéØ VALIDA√á√ÉO CONCLU√çDA');
    console.log('===============================');
    console.log('‚úÖ Sistema de Bloqueio: Estrutura OK');
    console.log('‚úÖ Sistema Agreement: Estrutura OK');
    console.log('üìù Pr√≥ximo: Testes de integra√ß√£o');
    
  } catch (error) {
    console.error('‚ùå Erro na valida√ß√£o:', error.message);
  } finally {
    await mongoose.connection.close();
  }
}


if (require.main === module) {
  validateSystems();
}

module.exports = validateSystems;
