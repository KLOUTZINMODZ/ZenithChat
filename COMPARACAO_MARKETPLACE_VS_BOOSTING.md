# üìä Compara√ß√£o: Marketplace vs Boosting

**Data:** 15/10/2025  
**Objetivo:** Garantir que o fluxo de boosting √© id√™ntico ao marketplace

---

## üîÑ Fluxo Marketplace (purchasesRoutes.js)

### **Confirma√ß√£o de Entrega (Comprador confirma):**

```javascript
// 1. CREDITAR VENDEDOR (95%)
const seller = await User.findById(purchase.sellerId).session(session);
const before = round2(seller.walletBalance || 0);
const after = round2(before + Number(purchase.sellerReceives));
seller.walletBalance = after;
await seller.save({ session });

// 2. WALLET LEDGER (Vendedor - Cr√©dito)
const releaseCreated = await WalletLedger.create([{
  userId: purchase.sellerId,
  txId: null,
  direction: 'credit',
  reason: 'purchase_release',
  amount: Number(purchase.sellerReceives),
  operationId: `purchase_release:${purchase._id.toString()}`,
  balanceBefore: before,
  balanceAfter: after,
  metadata: { 
    source: 'purchase', 
    purchaseId: purchase._id.toString(), 
    itemId: purchase.itemId, 
    price: Number(purchase.price), 
    feeAmount: Number(purchase.feeAmount || 0), 
    sellerReceives: Number(purchase.sellerReceives) 
  }
}], { session });

// 3. MEDIATOR LOG (Release)
await Mediator.updateOne(
  { operationId: `release:${purchase._id.toString()}` },
  {
    $setOnInsert: {
      eventType: 'release',
      amount: Number(purchase.sellerReceives),
      currency: 'BRL',
      operationId: `release:${purchase._id.toString()}`,
      source: 'ZenithChatApi',
      occurredAt: new Date(),
      reference: {
        purchaseId: purchase._id,
        orderId: null,
        walletLedgerId: releaseCreated[0]?._id || null,
        transactionId: null,
        asaasTransferId: null
      },
      metadata: { 
        price: Number(purchase.price), 
        feeAmount: Number(purchase.feeAmount || 0), 
        sellerReceives: Number(purchase.sellerReceives) 
      },
      description: 'Libera√ß√£o de escrow ao vendedor'
    }
  },
  { upsert: true, session }
);

// 4. TENTAR CREDITAR MEDIADOR (5%)
try {
  const feeAmount = Number(purchase.feeAmount || 0);
  if (feeAmount > 0) {
    let mediatorUser = null;
    const envId = process.env.MEDIATOR_USER_ID;
    const envEmail = process.env.MEDIATOR_EMAIL;
    
    // Tentar por ID
    if (envId) {
      try { mediatorUser = await User.findById(envId).session(session); } catch (_) {}
    }
    
    // Tentar por email
    if (!mediatorUser && envEmail) {
      try { mediatorUser = await User.findOne({ email: envEmail }).session(session); } catch (_) {}
    }
    
    // SE ENCONTROU mediador, creditar
    if (mediatorUser) {
      const medBefore = round2(mediatorUser.walletBalance || 0);
      const medAfter = round2(medBefore + feeAmount);
      mediatorUser.walletBalance = medAfter;
      await mediatorUser.save({ session });
      
      // WALLET LEDGER (Mediador - Cr√©dito)
      const created = await WalletLedger.create([{
        userId: mediatorUser._id,
        txId: null,
        direction: 'credit',
        reason: 'purchase_fee',
        amount: feeAmount,
        operationId: `purchase_fee:${purchase._id.toString()}`,
        balanceBefore: medBefore,
        balanceAfter: medAfter,
        metadata: { 
          source: 'purchase', 
          purchaseId: purchase._id.toString(), 
          itemId: purchase.itemId, 
          sellerId: purchase.sellerId, 
          price: Number(purchase.price), 
          feeAmount: feeAmount, 
          sellerReceives: Number(purchase.sellerReceives) 
        }
      }], { session });
      
      // MEDIATOR LOG (Fee)
      await Mediator.create([{
        eventType: 'fee',
        amount: feeAmount,
        currency: 'BRL',
        operationId: `purchase_fee:${purchase._id.toString()}`,
        source: 'ZenithChatApi',
        occurredAt: new Date(),
        reference: {
          purchaseId: purchase._id,
          walletLedgerId: created[0]?._id || null,
          orderId: null,
          transactionId: null,
          asaasTransferId: null
        },
        metadata: { 
          price: Number(purchase.price), 
          feeAmount: feeAmount, 
          sellerReceives: Number(purchase.sellerReceives), 
          sellerId: purchase.sellerId 
        },
        description: 'Taxa de media√ß√£o (5%) creditada ao mediador'
      }], { session });
    } else {
      // SE N√ÉO ENCONTROU, apenas avisar (n√£o cria nada)
      logger?.warn?.('[PURCHASES] Mediator user not found; fee not credited');
    }
  }
} catch (e) {
  logger?.error?.('[PURCHASES] Failed to credit mediator fee', { error: e?.message });
}

// 5. WALLET LEDGER (Comprador - Settlement com amount: 0)
const buyer = await User.findById(purchase.buyerId).session(session);
const buyerBefore = round2(buyer?.walletBalance || 0);
await WalletLedger.create([{
  userId: purchase.buyerId,
  txId: null,
  direction: 'debit',
  reason: 'purchase_settle',
  amount: 0,
  operationId: `purchase_settle:${purchase._id.toString()}`,
  balanceBefore: buyerBefore,
  balanceAfter: buyerBefore,
  metadata: { 
    source: 'purchase', 
    purchaseId: purchase._id.toString(), 
    itemId: purchase.itemId 
  }
}], { session });

// 6. ATUALIZAR STATUS
purchase.status = 'completed';
purchase.deliveredAt = new Date();
```

---

## üîÑ Fluxo Boosting (boostingChatController.js)

### **Confirma√ß√£o de Entrega (Cliente confirma):**

```javascript
// 1. VERIFICAR ESCROW (Espec√≠fico do boosting)
const existingEscrow = await WalletLedger.findOne({
  userId: clientUserId,
  reason: 'boosting_escrow',
  'metadata.agreementId': agreement?._id?.toString()
}).session(session);

if (existingEscrow) {
  // Cliente j√° foi debitado - criar ledger com amount: 0
  await WalletLedger.create([{
    userId: clientUserId,
    txId: null,
    direction: 'debit',
    reason: 'boosting_escrow_release',
    amount: 0,
    operationId: `boosting_escrow_release:${agreement._id}`,
    balanceBefore: clientBalanceBefore,
    balanceAfter: clientBalanceAfter,
    metadata: { /* ... */ }
  }], { session });
} else {
  // Fluxo legado - debitar agora
  // (c√≥digo de d√©bito)
}

// 2. CREDITAR BOOSTER (95%)
const boosterUser = await User.findById(boosterUserId).session(session);
const boosterBalanceBefore = round2(boosterUser.walletBalance || 0);
const boosterBalanceAfter = round2(boosterBalanceBefore + boosterReceives);
boosterUser.walletBalance = boosterBalanceAfter;
await boosterUser.save({ session });

// 3. WALLET LEDGER (Booster - Cr√©dito)
const boosterLedger = await WalletLedger.create([{
  userId: boosterUserId,
  txId: null,
  direction: 'credit',
  reason: 'boosting_release',
  amount: boosterReceives,
  operationId: `boosting_release:${agreement._id}`,
  balanceBefore: boosterBalanceBefore,
  balanceAfter: boosterBalanceAfter,
  metadata: {
    source: 'boosting',
    agreementId: agreement._id?.toString(),
    conversationId: conversationId,
    clientId: clientUserId?.toString(),
    price: Number(price),
    feeAmount: Number(feeAmount),
    boosterReceives: Number(boosterReceives),
    feePercent: 0.05,
    type: 'boosting_service'
  }
}], { session });

// 4. MEDIATOR LOG (Release)
await Mediator.create([{
  eventType: 'release',
  amount: boosterReceives,
  currency: 'BRL',
  operationId: `boosting_release:${agreement._id}`,
  source: 'ZenithChatApi',
  occurredAt: new Date(),
  reference: {
    agreementId: agreement._id,
    conversationId: conversationId,
    walletLedgerId: boosterLedger[0]?._id || null,
    transactionId: null,
    asaasTransferId: null
  },
  metadata: {
    price: Number(price),
    feeAmount: Number(feeAmount),
    boosterReceives: Number(boosterReceives),
    clientId: clientUserId?.toString(),
    boosterId: boosterUserId?.toString(),
    feePercent: 0.05,
    serviceType: 'boosting'
  },
  description: 'Libera√ß√£o de pagamento ao booster'
}], { session });

// 5. REGISTRAR TAXA MEDIADOR (5%) - APENAS AUDITORIA
try {
  if (feeAmount > 0) {
    // MEDIATOR LOG (Fee) - SEM creditar usu√°rio
    await Mediator.create([{
      eventType: 'fee',
      amount: feeAmount,
      currency: 'BRL',
      operationId: `boosting_fee:${agreement._id}`,
      source: 'ZenithChatApi',
      occurredAt: new Date(),
      reference: {
        agreementId: agreement._id,
        conversationId: conversationId,
        walletLedgerId: null, // ‚ùå NULL (n√£o h√° WalletLedger do mediador)
        transactionId: null,
        asaasTransferId: null
      },
      metadata: { 
        price: Number(price), 
        feeAmount: feeAmount, 
        boosterReceives: Number(boosterReceives), 
        boosterId: boosterUserId?.toString(),
        clientId: clientUserId?.toString()
      },
      description: 'Taxa de media√ß√£o (5%) - Boosting'
    }], { session });
  }
} catch (e) {
  console.error('[BOOSTING] Erro ao registrar taxa do mediador:', e?.message);
}

// 6. ATUALIZAR STATUS
agreement.status = 'completed';
agreement.completedAt = new Date();
```

---

## ‚ùå DIFEREN√áAS ENCONTRADAS

### **1. Creditar Usu√°rio Mediador:**

| Marketplace | Boosting | Status |
|-------------|----------|--------|
| ‚úÖ Tenta creditar usu√°rio mediador | ‚ùå N√ÉO credita usu√°rio | ‚ùå DIFERENTE |
| ‚úÖ Cria WalletLedger do mediador (se encontrado) | ‚ùå N√ÉO cria WalletLedger | ‚ùå DIFERENTE |
| ‚úÖ SEMPRE cria Mediator log (fee) | ‚úÖ SEMPRE cria Mediator log (fee) | ‚úÖ IGUAL |

---

### **2. WalletLedger do Comprador/Cliente:**

| Marketplace | Boosting | Status |
|-------------|----------|--------|
| ‚úÖ Cria `purchase_settle` (amount: 0) | ‚ùå N√ÉO cria `boosting_settle` | ‚ùå FALTANDO |

---

### **3. Mediator.updateOne vs Mediator.create (Release):**

| Marketplace | Boosting | Status |
|-------------|----------|--------|
| ‚úÖ Usa `updateOne` com `upsert` (idempotente) | ‚ùå Usa `create` (pode duplicar) | ‚ö†Ô∏è POTENCIAL BUG |

---

## ‚úÖ SEMELHAN√áAS

| Aspecto | Marketplace | Boosting | Status |
|---------|-------------|----------|--------|
| **Creditar fornecedor** | ‚úÖ Sim (seller) | ‚úÖ Sim (booster) | ‚úÖ IGUAL |
| **WalletLedger fornecedor** | ‚úÖ Sim | ‚úÖ Sim | ‚úÖ IGUAL |
| **Mediator log (release)** | ‚úÖ Sim | ‚úÖ Sim | ‚úÖ IGUAL |
| **Mediator log (fee)** | ‚úÖ Sim | ‚úÖ Sim | ‚úÖ IGUAL |
| **Transa√ß√£o at√¥mica** | ‚úÖ runTx | ‚úÖ runTx | ‚úÖ IGUAL |

---

## üîß CORRE√á√ïES NECESS√ÅRIAS

### **1. Adicionar Settlement do Cliente (amount: 0)**

O marketplace cria um `purchase_settle` com amount: 0 para o comprador aparecer no hist√≥rico.

**Boosting deveria fazer o mesmo:**

```javascript
// Ap√≥s registrar taxa do mediador, adicionar:
try {
  const client = await User.findById(clientUserId).session(session);
  const clientBefore = round2(client?.walletBalance || 0);
  await WalletLedger.create([{
    userId: clientUserId,
    txId: null,
    direction: 'debit',
    reason: 'boosting_settle',
    amount: 0,
    operationId: `boosting_settle:${agreement._id}`,
    balanceBefore: clientBefore,
    balanceAfter: clientBefore,
    metadata: { 
      source: 'boosting', 
      agreementId: agreement._id?.toString(),
      conversationId: conversationId
    }
  }], { session });
} catch (_) {}
```

---

### **2. Usar updateOne (Idempotente) para Mediator Release**

O marketplace usa `updateOne` com `upsert` para evitar duplicatas.

**Mudar de:**
```javascript
await Mediator.create([{ ... }])
```

**Para:**
```javascript
await Mediator.updateOne(
  { operationId: `boosting_release:${agreement._id}` },
  {
    $setOnInsert: {
      eventType: 'release',
      // ... resto dos campos
    }
  },
  { upsert: true, session }
);
```

---

### **3. Decidir sobre Usu√°rio Mediador**

**Op√ß√£o A: Seguir marketplace (tentar creditar usu√°rio)**
```javascript
// Copiar exatamente o c√≥digo do marketplace
let mediatorUser = null;
if (envId) { ... }
if (!mediatorUser && envEmail) { ... }
if (mediatorUser) {
  // Creditar e criar WalletLedger
}
// SEMPRE criar Mediator log (dentro ou fora do if)
```

**Op√ß√£o B: Boosting sem usu√°rio mediador (atual)**
```javascript
// Apenas criar Mediator log (sem creditar usu√°rio)
await Mediator.create([{ eventType: 'fee', ... }])
```

**‚ùì Pergunta: O marketplace precisa do usu√°rio mediador ou tamb√©m funciona sem?**

---

## üìä Resumo das Diferen√ßas

| # | Aspecto | Marketplace | Boosting | A√ß√£o |
|---|---------|-------------|----------|------|
| 1 | Creditar usu√°rio mediador | ‚úÖ Tenta | ‚ùå N√£o | Decidir |
| 2 | WalletLedger mediador | ‚úÖ Se encontrado | ‚ùå N√£o | Decidir |
| 3 | Settlement comprador | ‚úÖ Sim (amount: 0) | ‚ùå N√£o | ‚úÖ Adicionar |
| 4 | Mediator.release | ‚úÖ updateOne (idempotente) | ‚ùå create | ‚úÖ Mudar |
| 5 | Mediator.fee | ‚úÖ create | ‚úÖ create | ‚úÖ Igual |

---

## ‚úÖ CHECKLIST DE ALINHAMENTO

Para o boosting ficar **100% id√™ntico** ao marketplace:

- [ ] Adicionar `boosting_settle` (cliente, amount: 0)
- [ ] Mudar `Mediator.create` ‚Üí `Mediator.updateOne` (release)
- [ ] Decidir: creditar usu√°rio mediador ou n√£o?
  - [ ] Se SIM: copiar c√≥digo do marketplace
  - [ ] Se N√ÉO: remover do marketplace tamb√©m

---

**Status:** ‚ö†Ô∏è **DIFEREN√áAS IDENTIFICADAS**

**Pr√≥xima a√ß√£o:** Implementar corre√ß√µes para alinhar 100% com marketplace

