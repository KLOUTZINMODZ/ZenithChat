# üöÄ Guia R√°pido de Integra√ß√£o 2FA

## ‚ö° Setup R√°pido (5 minutos)

### 1. Verificar Arquivos Criados ‚úÖ

Todos os arquivos necess√°rios j√° foram criados:
- ‚úÖ `src/models/TwoFactorAuth.js`
- ‚úÖ `src/controllers/twoFactorAuthController.js`
- ‚úÖ `src/middleware/rateLimiters.js` (modificado)
- ‚úÖ `src/routes/authRoutes.js` (modificado)

### 2. Configurar Vari√°veis de Ambiente

Adicione ao seu arquivo `.env`:
```env
RATE_LIMIT_2FA_MAX=3
```

**Nota**: O JWT_SECRET j√° deve estar configurado.

### 3. Integrar no Fluxo de Login

#### Op√ß√£o A: Criar novo endpoint de login com 2FA

Crie ou modifique `src/controllers/authController.js`:

```javascript
const User = require('../models/User');
const bcrypt = require('bcryptjs');
const twoFactorAuthController = require('./twoFactorAuthController');
const emailService = require('../services/emailService'); // Seu servi√ßo de email
const logger = require('../utils/logger');

exports.login = async (req, res) => {
  try {
    const { email, password } = req.body;
    
    // Valida√ß√£o b√°sica
    if (!email || !password) {
      return res.status(400).json({
        success: false,
        message: 'Email and password are required'
      });
    }
    
    // Buscar usu√°rio
    const user = await User.findOne({ email });
    
    if (!user) {
      // Delay para prevenir user enumeration
      await new Promise(resolve => setTimeout(resolve, Math.random() * 100 + 200));
      return res.status(401).json({
        success: false,
        message: 'Invalid credentials'
      });
    }
    
    // Verificar senha (assumindo que voc√™ tem hash de senha)
    // Se n√£o tiver, remova esta valida√ß√£o
    // const isValidPassword = await bcrypt.compare(password, user.password);
    // if (!isValidPassword) {
    //   await new Promise(resolve => setTimeout(resolve, Math.random() * 100 + 200));
    //   return res.status(401).json({
    //     success: false,
    //     message: 'Invalid credentials'
    //   });
    // }
    
    // Verificar se usu√°rio est√° banido
    if (user.isBanned()) {
      return res.status(403).json({
        success: false,
        message: 'Account suspended',
        banned: true
      });
    }
    
    // Gerar c√≥digo 2FA
    const { code, tempToken, expiresAt } = await twoFactorAuthController.generate2FACode(user._id);
    
    // Enviar c√≥digo por email
    try {
      await emailService.send2FACode(user.email, code, user.name);
    } catch (emailError) {
      logger.error('Failed to send 2FA code', { userId: user._id, error: emailError.message });
      return res.status(500).json({
        success: false,
        message: 'Failed to send verification code. Please try again.'
      });
    }
    
    // Retornar tempToken para o cliente
    return res.status(200).json({
      success: true,
      message: 'Verification code sent to your email',
      data: {
        tempToken,
        requiresTwoFactor: true,
        expiresIn: 900 // 15 minutos em segundos
      }
    });
    
  } catch (error) {
    logger.error('Login error:', error);
    return res.status(500).json({
      success: false,
      message: 'Internal server error'
    });
  }
};
```

#### Op√ß√£o B: Adicionar ao server.js diretamente

Se voc√™ n√£o tem um authController, adicione ao `server.js`:

```javascript
// Ap√≥s as outras rotas de autentica√ß√£o
app.post('/api/auth/login', authLimiter, async (req, res) => {
  try {
    const { email, password } = req.body;
    
    const user = await User.findOne({ email });
    if (!user) {
      await new Promise(resolve => setTimeout(resolve, 300));
      return res.status(401).json({ success: false, message: 'Invalid credentials' });
    }
    
    if (user.isBanned()) {
      return res.status(403).json({ success: false, message: 'Account suspended' });
    }
    
    const twoFactorAuthController = require('./src/controllers/twoFactorAuthController');
    const { code, tempToken } = await twoFactorAuthController.generate2FACode(user._id);
    
    // TODO: Enviar c√≥digo por email
    console.log(`2FA Code for ${email}: ${code}`); // REMOVER EM PRODU√á√ÉO!
    
    res.json({
      success: true,
      message: 'Verification code sent',
      data: { tempToken, requiresTwoFactor: true }
    });
  } catch (error) {
    logger.error('Login error:', error);
    res.status(500).json({ success: false, message: 'Internal server error' });
  }
});
```

### 4. Configurar Servi√ßo de Email

#### Se voc√™ j√° tem emailService configurado:

Adicione o m√©todo `send2FACode`:

```javascript
// src/services/emailService.js

exports.send2FACode = async (email, code, userName) => {
  const html = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h2>C√≥digo de Verifica√ß√£o</h2>
      <p>Ol√° ${userName},</p>
      <p>Seu c√≥digo de verifica√ß√£o √©:</p>
      <div style="font-size: 32px; font-weight: bold; color: #007bff; letter-spacing: 4px; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
        ${code}
      </div>
      <p>Este c√≥digo expira em <strong>15 minutos</strong>.</p>
      <p style="color: #dc3545; font-size: 14px;">
        ‚ö†Ô∏è Nunca compartilhe este c√≥digo com ningu√©m.
      </p>
    </div>
  `;
  
  return await transporter.sendMail({
    from: process.env.EMAIL_USER,
    to: email,
    subject: 'Seu c√≥digo de verifica√ß√£o - Zenith',
    html
  });
};
```

#### Se N√ÉO tem emailService, crie um b√°sico:

```javascript
// src/services/emailService.js
const nodemailer = require('nodemailer');

const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASSWORD
  }
});

exports.send2FACode = async (email, code, userName) => {
  const html = `
    <div style="font-family: Arial, sans-serif; max-width: 600px;">
      <h2>C√≥digo de Verifica√ß√£o</h2>
      <p>Ol√° ${userName},</p>
      <p>Seu c√≥digo: <strong style="font-size: 24px; color: #007bff;">${code}</strong></p>
      <p>Expira em 15 minutos.</p>
    </div>
  `;
  
  return await transporter.sendMail({
    from: process.env.EMAIL_USER,
    to: email,
    subject: 'C√≥digo de Verifica√ß√£o',
    html
  });
};
```

Instale nodemailer se necess√°rio:
```bash
npm install nodemailer
```

## üß™ Testar Implementa√ß√£o

### 1. Testar endpoint diretamente (sem email)

Para desenvolvimento, voc√™ pode temporariamente logar o c√≥digo:

```javascript
// NO CONTROLLER DE LOGIN (APENAS PARA TESTE)
const { code, tempToken } = await twoFactorAuthController.generate2FACode(user._id);

// REMOVER EM PRODU√á√ÉO!
console.log('=== 2FA CODE (TESTE) ===');
console.log('Email:', user.email);
console.log('Code:', code);
console.log('TempToken:', tempToken);
console.log('========================');
```

### 2. Testar com cURL

```bash
# 1. Login (gera c√≥digo)
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"senha123"}'

# Resposta:
# {
#   "success": true,
#   "data": {
#     "tempToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
#     "requiresTwoFactor": true
#   }
# }

# 2. Verificar c√≥digo (copie o c√≥digo do console e o tempToken da resposta)
curl -X POST http://localhost:5000/api/auth/verify-2fa-login \
  -H "Content-Type: application/json" \
  -d '{
    "code":"123456",
    "tempToken":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }'

# Resposta de sucesso:
# {
#   "success": true,
#   "data": {
#     "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
#     "user": { "id": "...", "name": "...", "email": "..." }
#   }
# }
```

### 3. Testar prote√ß√µes

```bash
# Testar c√≥digo inv√°lido (deve retornar remainingAttempts)
curl -X POST http://localhost:5000/api/auth/verify-2fa-login \
  -H "Content-Type: application/json" \
  -d '{"code":"000000","tempToken":"..."}'

# Testar rate limiting (fazer 4 requests r√°pidos)
for i in {1..4}; do
  curl -X POST http://localhost:5000/api/auth/verify-2fa-login \
    -H "Content-Type: application/json" \
    -d '{"code":"000000","tempToken":"..."}'
  echo ""
done
# 4¬∫ request deve retornar HTTP 429
```

## üì± Frontend Integration

### React Example

```tsx
// pages/Login.tsx
const handleLogin = async (email: string, password: string) => {
  const res = await fetch('/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });
  
  const data = await res.json();
  
  if (data.requiresTwoFactor) {
    sessionStorage.setItem('tempToken', data.data.tempToken);
    router.push('/verify-2fa');
  }
};

// pages/Verify2FA.tsx
const handleVerify = async (code: string) => {
  const tempToken = sessionStorage.getItem('tempToken');
  
  const res = await fetch('/api/auth/verify-2fa-login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ code, tempToken })
  });
  
  const data = await res.json();
  
  if (data.success) {
    localStorage.setItem('authToken', data.data.token);
    router.push('/dashboard');
  }
};
```

## ‚ö†Ô∏è Checklist Pr√©-Produ√ß√£o

Antes de colocar em produ√ß√£o, verifique:

- [ ] `JWT_SECRET` configurado (m√≠nimo 32 caracteres)
- [ ] `RATE_LIMIT_2FA_MAX=3` adicionado ao `.env`
- [ ] Servi√ßo de email configurado e testado
- [ ] `NODE_ENV=production` em produ√ß√£o (desabilita stack traces)
- [ ] HTTPS configurado (obrigat√≥rio)
- [ ] Rate limiters testados
- [ ] Logs de seguran√ßa configurados
- [ ] Alertas de tentativas excessivas configurados
- [ ] Testado fluxo completo em staging
- [ ] Removidos console.logs de desenvolvimento

## üêõ Troubleshooting

### Erro: "TwoFactorAuth model not found"
```bash
# Certifique-se que o arquivo foi criado:
ls src/models/TwoFactorAuth.js
```

### Erro: "twoFactorLimiter is not defined"
```bash
# Verifique se foi exportado corretamente em rateLimiters.js
grep "twoFactorLimiter" src/middleware/rateLimiters.js
```

### Emails n√£o est√£o sendo enviados
```javascript
// Adicione log para debug:
logger.info('Sending 2FA code', { email, hasCode: !!code });
```

### Rate limiting muito agressivo em desenvolvimento
```env
# Aumente temporariamente em .env (N√ÉO EM PRODU√á√ÉO):
RATE_LIMIT_2FA_MAX=10
```

## üìû Suporte

- **Documenta√ß√£o de Seguran√ßa**: `2FA_SECURITY_DOCUMENTATION.md`
- **Exemplos Completos**: `2FA_USAGE_EXAMPLES.md`
- **Resumo Executivo**: `2FA_IMPLEMENTATION_SUMMARY.md`

---

**Tempo estimado de integra√ß√£o**: 15-30 minutos (com email configurado)
