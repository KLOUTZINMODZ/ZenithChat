# Configura√ß√£o do Sistema de Webhook para Marketplace Highlights

## üéØ Vis√£o Geral
O sistema de webhook foi movido da API principal (Vercel) para a HackloteChatApi devido √†s limita√ß√µes do Vercel com WebSockets e webhooks persistentes.

## üîß Arquitetura da Solu√ß√£o

### Fluxo do Webhook
1. **Mercado Pago** ‚Üí **HackloteChatApi** (webhook)
2. **HackloteChatApi** ‚Üí **API Vercel** (comunica√ß√£o interna)
3. **API Vercel** aplica highlights nos itens do marketplace

## ‚öôÔ∏è Configura√ß√£o das Vari√°veis de Ambiente

### HackloteChatApi (.env)
```env
# Configura√ß√£o existente...
PORT=3001
MONGODB_URI=your_mongodb_connection_string
NODE_ENV=development

# Novas vari√°veis para webhook
VERCEL_API_URL=https://your-main-api.vercel.app
VERCEL_API_SECRET=your_secure_secret_key_here
MERCADO_PAGO_ACCESS_TOKEN=your_mercado_pago_token
```

### API Principal Vercel (.env ou configura√ß√£o)
```env
# Configura√ß√£o existente...
MONGODB_URI=your_mongodb_connection_string
JWT_SECRET=your_jwt_secret

# Novas vari√°veis para comunica√ß√£o interna
VERCEL_API_SECRET=your_secure_secret_key_here
CHAT_API_URL=https://12zku8.instatunnel.my
```

## üöÄ Endpoints Criados

### Na HackloteChatApi
- **POST** `/api/marketplace-webhook/mercadopago-webhook`
  - Recebe notifica√ß√µes do Mercado Pago
  - Processa pagamentos aprovados
  - Comunica com API principal

- **POST** `/api/marketplace-webhook/test-webhook` 
  - Endpoint para testes durante desenvolvimento
  - Simula notifica√ß√µes do Mercado Pago

- **GET** `/api/marketplace-webhook/health`
  - Health check do servi√ßo de webhook

### Na API Principal (Vercel)
- **POST** `/api/marketplace-highlights-internal`
  - Endpoint interno para aplicar highlights
  - Aceita apenas chamadas da HackloteChatApi
  - Autenticado via secret interno

## üîê Seguran√ßa

### Autentica√ß√£o entre APIs
- Header `X-Webhook-Source: HackloteChatApi` para identifica√ß√£o
- Header `Authorization: Bearer SECRET` para autentica√ß√£o
- Verifica√ß√£o de secret interno compartilhado

### Valida√ß√µes
- Estrutura das notifica√ß√µes do Mercado Pago
- Status de pagamento (apenas 'approved')
- Exist√™ncia do usu√°rio
- Formato da refer√™ncia externa

## üìã URLs de Configura√ß√£o

### Para Mercado Pago (produ√ß√£o)
```
Notification URL: https://your-chat-api-domain.com/api/marketplace-webhook/mercadopago-webhook
```

### Para desenvolvimento local
```
Notification URL: https://12zku8.instatunnel.my/api/marketplace-webhook/mercadopago-webhook
```

## üß™ Como Testar

### 1. Teste Local Simples
```bash
curl -X POST https://12zku8.instatunnel.my/api/marketplace-webhook/test-webhook \
  -H "Content-Type: application/json" \
  -d '{"userId": "USER_ID_HERE", "paymentId": "test_payment_123"}'
```

### 2. Simula√ß√£o de Webhook do Mercado Pago
```bash
curl -X POST https://12zku8.instatunnel.my/api/marketplace-webhook/mercadopago-webhook \
  -H "Content-Type: application/json" \
  -d '{
    "type": "payment",
    "data": {
      "id": "123456789"
    },
    "user_id": "USER_ID_HERE"
  }'
```

### 3. Health Check
```bash
curl https://12zku8.instatunnel.my/api/marketplace-webhook/health
```

## üîÑ Processo de Deploy

### 1. HackloteChatApi
1. Configurar vari√°veis de ambiente
2. Garantir que o servidor est√° rodando
3. Testar conectividade com a API principal

### 2. API Principal (Vercel)
1. Adicionar vari√°vel `VERCEL_API_SECRET`
2. Fazer deploy do novo endpoint `/api/marketplace-highlights-internal`
3. Atualizar vari√°vel `CHAT_API_URL` se necess√°rio

### 3. Mercado Pago
1. Atualizar URL de notifica√ß√£o para apontar para HackloteChatApi
2. Testar webhook com pagamento real

## ‚ö†Ô∏è Troubleshooting

### Erro de Conex√£o
```
Erro: ECONNREFUSED ou ETIMEDOUT
```
**Solu√ß√£o**: Verificar se HackloteChatApi est√° rodando e acess√≠vel

### Erro de Autentica√ß√£o
```
Erro: Secret interno inv√°lido
```
**Solu√ß√£o**: Verificar se `VERCEL_API_SECRET` √© igual nas duas APIs

### Webhook n√£o Recebe Notifica√ß√µes
```
Mercado Pago n√£o est√° chamando o webhook
```
**Solu√ß√£o**: Verificar URL configurada no Mercado Pago e firewall/proxy

## üìä Logs e Monitoramento

### Logs Importantes
- ‚úÖ Webhook recebido: `üîî Webhook Mercado Pago recebido`
- ‚úÖ Pagamento processado: `üí∞ Detalhes do pagamento obtidos`
- ‚úÖ Highlight aplicado: `‚úÖ Highlight aplicado com sucesso`
- ‚ùå Erro de comunica√ß√£o: `‚ùå Erro ao comunicar com API principal`

### Monitoramento
- Status de sa√∫de: `GET /api/marketplace-webhook/health`
- Logs detalhados no console da HackloteChatApi
- M√©tricas de sucesso/falha nos logs

## üéâ Benef√≠cios da Nova Arquitetura

1. **Compatibilidade**: Funciona perfeitamente com webhooks
2. **Confiabilidade**: Servidor dedicado sempre online
3. **Escalabilidade**: Pode processar m√∫ltiplos webhooks simultaneamente
4. **Monitoramento**: Logs detalhados e health checks
5. **Flexibilidade**: F√°cil de estender para outros tipos de webhook

---

**Status**: ‚úÖ Implementa√ß√£o Completa
**Pr√≥ximo Passo**: Testar comunica√ß√£o entre APIs e configurar em produ√ß√£o
