/**
 * Script de Diagn√≥stico e Corre√ß√£o: Agreement Faltante
 * 
 * Objetivo: Verificar e criar Agreement para conversas que foram aceitas
 * mas n√£o t√™m Agreement criado.
 * 
 * Uso: node fix-missing-agreement.js <conversationId>
 */

require('dotenv').config();
const mongoose = require('mongoose');
const Conversation = require('./src/models/Conversation');
const Agreement = require('./src/models/Agreement');
const AcceptedProposal = require('./src/models/AcceptedProposal');
const User = require('./src/models/User');

const conversationId = process.argv[2] || '68ee956fd6d556c36cd373bb';

async function diagnoseAndFix() {
  try {
    console.log('üîç Conectando ao MongoDB...');
    await mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/hacklote_chat');
    console.log('‚úÖ Conectado ao MongoDB\n');

    console.log(`üìã Analisando conversa: ${conversationId}\n`);

    // 1. Buscar conversa
    console.log('1Ô∏è‚É£ Buscando conversa...');
    const conversation = await Conversation.findById(conversationId);
    
    if (!conversation) {
      console.error('‚ùå Conversa n√£o encontrada!');
      process.exit(1);
    }
    
    console.log('‚úÖ Conversa encontrada:');
    console.log(`   - Status: ${conversation.status}`);
    console.log(`   - isTemporary: ${conversation.isTemporary}`);
    console.log(`   - boostingStatus: ${conversation.boostingStatus}`);
    console.log(`   - Participantes: ${conversation.participants.length}`);
    console.log(`   - Metadata:`, conversation.metadata ? Object.fromEntries(conversation.metadata) : {});
    console.log('');

    // 2. Buscar Agreement
    console.log('2Ô∏è‚É£ Buscando Agreement...');
    let agreement = await Agreement.findOne({ conversationId });
    
    if (agreement) {
      console.log('‚úÖ Agreement encontrado:');
      console.log(`   - agreementId: ${agreement.agreementId}`);
      console.log(`   - status: ${agreement.status}`);
      console.log(`   - totalAmount: R$ ${agreement.financial?.totalAmount}`);
      console.log(`   - Client: ${agreement.parties?.client?.name} (${agreement.parties?.client?.userid})`);
      console.log(`   - Booster: ${agreement.parties?.booster?.name} (${agreement.parties?.booster?.userid})`);
      console.log('\n‚úÖ DIAGN√ìSTICO: Agreement existe, n√£o h√° problema!');
      console.log('   Se o erro persiste, verifique se o ID da conversa est√° correto.');
      process.exit(0);
    }
    
    console.log('‚ö†Ô∏è  Agreement N√ÉO encontrado! Verificando AcceptedProposal...\n');

    // 3. Buscar AcceptedProposal
    console.log('3Ô∏è‚É£ Buscando AcceptedProposal...');
    const acceptedProposal = await AcceptedProposal.findOne({ conversationId });
    
    if (acceptedProposal) {
      console.log('‚úÖ AcceptedProposal encontrado:');
      console.log(`   - _id: ${acceptedProposal._id}`);
      console.log(`   - price: R$ ${acceptedProposal.price}`);
      console.log(`   - Client: ${acceptedProposal.client?.name}`);
      console.log(`   - Booster: ${acceptedProposal.booster?.name}`);
      console.log('\nüìù Tentando migra√ß√£o autom√°tica...\n');
      
      try {
        const AgreementMigration = require('./src/middleware/agreementMigrationMiddleware');
        agreement = await AgreementMigration.migrateProposalToAgreement(acceptedProposal);
        
        console.log('‚úÖ Agreement criado via migra√ß√£o:');
        console.log(`   - agreementId: ${agreement.agreementId}`);
        console.log(`   - status: ${agreement.status}`);
        console.log('\n‚úÖ CORRE√á√ÉO APLICADA! Teste novamente a confirma√ß√£o de entrega.');
        process.exit(0);
      } catch (migrationError) {
        console.error('‚ùå Erro na migra√ß√£o:', migrationError.message);
        console.log('\n‚ö†Ô∏è  Tentando criar Agreement manualmente...\n');
      }
    } else {
      console.log('‚ö†Ô∏è  AcceptedProposal N√ÉO encontrado!\n');
    }

    // 4. Criar Agreement manualmente
    console.log('4Ô∏è‚É£ Criando Agreement manualmente...');
    
    // Extrair dados da conversa
    const participants = conversation.participants;
    if (participants.length < 2) {
      console.error('‚ùå Conversa precisa ter pelo menos 2 participantes!');
      process.exit(1);
    }

    // Identificar cliente e booster
    const metadata = conversation.metadata ? Object.fromEntries(conversation.metadata) : {};
    
    let clientId, boosterId;
    
    // Tentar identificar pelos participantes (assumir primeiro = cliente, segundo = booster)
    if (participants.length >= 2) {
      clientId = participants[0];
      boosterId = participants[1];
    }

    console.log(`   - ClientId: ${clientId}`);
    console.log(`   - BoosterId: ${boosterId}`);

    // Buscar dados dos usu√°rios
    const clientUser = await User.findById(clientId);
    const boosterUser = await User.findById(boosterId);

    if (!clientUser || !boosterUser) {
      console.error('‚ùå N√£o foi poss√≠vel encontrar dados dos usu√°rios!');
      console.log(`   - Cliente encontrado: ${!!clientUser}`);
      console.log(`   - Booster encontrado: ${!!boosterUser}`);
      process.exit(1);
    }

    console.log(`   - Cliente: ${clientUser.name || clientUser.username}`);
    console.log(`   - Booster: ${boosterUser.name || boosterUser.username}`);

    // Extrair pre√ßo do metadata (verificar m√∫ltiplos caminhos poss√≠veis)
    const proposalPrice = metadata.proposalData?.price || metadata.price || metadata.proposedPrice || 0;
    let proposalId = metadata.proposalId || metadata.boostingId || 'unknown';
    
    // Se proposalId est√° no formato composto (boostingId_boosterId_timestamp), extrair apenas boostingId
    if (proposalId.includes('_')) {
      const parts = proposalId.split('_');
      proposalId = parts[0]; // Usa apenas o boostingId (primeira parte)
      console.log(`   - ProposalId composto detectado, usando boostingId: ${proposalId}`);
    }

    console.log(`   - Pre√ßo: R$ ${proposalPrice}`);
    console.log(`   - ProposalId: ${proposalId}`);

    if (proposalPrice <= 0) {
      console.error('\n‚ö†Ô∏è  AVISO: Pre√ßo n√£o encontrado no metadata!');
      console.log('   Voc√™ pode fornecer manualmente:');
      console.log('   Edite o script e defina: const manualPrice = 100; // seu valor');
      
      // Op√ß√£o: definir pre√ßo manual aqui
      const manualPrice = null; // Defina o pre√ßo aqui se necess√°rio
      
      if (!manualPrice) {
        console.error('‚ùå Pre√ßo √© obrigat√≥rio para criar Agreement');
        process.exit(1);
      }
    }

    // Criar Agreement
    const proposalData = metadata.proposalData || {};
    const newAgreement = new Agreement({
      conversationId,
      proposalId,
      proposalSnapshot: {
        game: proposalData.game || metadata.game || 'N/A',
        category: proposalData.category || metadata.category || metadata.boostingCategory || 'Boosting',
        currentRank: proposalData.currentRank || metadata.currentRank || 'N/A',
        desiredRank: proposalData.desiredRank || metadata.desiredRank || 'N/A',
        description: proposalData.description || metadata.description || '',
        price: proposalPrice,
        originalPrice: proposalPrice,
        estimatedTime: proposalData.estimatedTime || metadata.estimatedTime || ''
      },
      parties: {
        client: {
          userid: clientId,
          name: clientUser.name || clientUser.username,
          email: clientUser.email,
          avatar: clientUser.avatar,
          metadata: new Map([
            ['isVerified', clientUser.isVerified || false],
            ['totalOrders', clientUser.totalOrders || 0],
            ['rating', clientUser.rating || 0]
          ])
        },
        booster: {
          userid: boosterId,
          name: boosterUser.name || boosterUser.username,
          email: boosterUser.email,
          avatar: boosterUser.avatar,
          rating: boosterUser.rating || 0,
          metadata: new Map([
            ['isVerified', boosterUser.isVerified || false],
            ['totalBoosts', boosterUser.totalBoosts || 0],
            ['completedBoosts', boosterUser.completedBoosts || 0]
          ])
        }
      },
      financial: {
        totalAmount: proposalPrice,
        currency: 'BRL',
        paymentStatus: 'pending'
      },
      status: 'active'
    });

    newAgreement.addAction('created', clientId, { 
      proposalId,
      createdBy: 'fix-script',
      reason: 'Missing agreement detected and auto-created'
    });

    await newAgreement.save();

    console.log('\n‚úÖ Agreement criado com sucesso!');
    console.log(`   - agreementId: ${newAgreement.agreementId}`);
    console.log(`   - _id: ${newAgreement._id}`);
    console.log(`   - status: ${newAgreement.status}`);
    console.log(`   - totalAmount: R$ ${newAgreement.financial.totalAmount}`);

    // Atualizar metadata da conversa
    if (!conversation.metadata) {
      conversation.metadata = new Map();
    }
    conversation.metadata.set('latestAgreementId', newAgreement.agreementId);
    await conversation.save();

    console.log('\n‚úÖ Conversa atualizada com agreementId');
    console.log('\nüéâ CORRE√á√ÉO COMPLETA!');
    console.log('\nüìù Pr√≥ximos passos:');
    console.log('   1. Tente confirmar a entrega novamente');
    console.log('   2. Deve funcionar sem o erro 404');
    console.log('   3. Monitore os logs para verificar');

  } catch (error) {
    console.error('\n‚ùå Erro durante execu√ß√£o:', error);
    console.error('Stack:', error.stack);
  } finally {
    await mongoose.disconnect();
    console.log('\nüîå Desconectado do MongoDB');
  }
}

// Executar
diagnoseAndFix();
