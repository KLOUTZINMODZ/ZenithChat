/**
 * Debug detalhado das notifica√ß√µes para identificar por que algumas funcionam e outras n√£o
 */

const axios = require('axios');

const CHAT_API_URL = 'https://vast-beans-agree.loca.lt/';
const USER_ID = '6897d82c8cdd40188e08a224';

console.log('üîç Debug detalhado das notifica√ß√µes...');

async function debugNotifications() {

  console.log('\n‚úÖ TESTE 1: Notifica√ß√£o que FUNCIONA');
  const workingNotification = {
    userIds: [USER_ID],
    notification: {
      id: `working_${Date.now()}`,
      title: 'Notifica√ß√£o Direcionada',
      message: 'Esta notifica√ß√£o foi enviada para seu user ID espec√≠fico!',
      type: 'targeted_test',
      priority: 'high',
      timestamp: new Date().toISOString(),
      isRead: false
    }
  };

  try {
    const response1 = await axios.post(`${CHAT_API_URL}/api/notifications/send`, workingNotification);
    console.log('üìä Resultado:', {
      success: response1.data.success,
      delivered: response1.data.results?.[0]?.delivered,
      notification: {
        id: response1.data.results?.[0]?.notification?.id,
        type: response1.data.results?.[0]?.notification?.type,
        title: response1.data.results?.[0]?.notification?.title
      }
    });
  } catch (error) {
    console.error('‚ùå Erro:', error.message);
  }


  await new Promise(resolve => setTimeout(resolve, 3000));


  console.log('\n‚ùå TESTE 2: Notifica√ß√£o que N√ÉO FUNCIONA');
  const notWorkingNotification = {
    userIds: [USER_ID],
    notification: {
      id: `not_working_${Date.now()}`,
      title: 'Nova Proposta Recebida!',
      message: 'Jo√£o enviou uma proposta de R$ 150,00 para seu boosting de League of Legends',
      type: 'new_proposal',
      link: '/boosting/123/proposals',
      image: 'https://via.placeholder.com/40',
      timestamp: new Date().toISOString(),
      isRead: false,
      relatedId: 'test_123',
      relatedType: 'BoostingRequest'
    },
    options: {
      persistent: true,
      retryOnFailure: true
    }
  };

  try {
    const response2 = await axios.post(`${CHAT_API_URL}/api/notifications/send`, notWorkingNotification);
    console.log('üìä Resultado:', {
      success: response2.data.success,
      delivered: response2.data.results?.[0]?.delivered,
      notification: {
        id: response2.data.results?.[0]?.notification?.id,
        type: response2.data.results?.[0]?.notification?.type,
        title: response2.data.results?.[0]?.notification?.title
      }
    });
  } catch (error) {
    console.error('‚ùå Erro:', error.message);
  }


  await new Promise(resolve => setTimeout(resolve, 3000));


  console.log('\nüß™ TESTE 3: Mudando apenas o TYPE da notifica√ß√£o que funciona');
  const typeTestNotification = {
    userIds: [USER_ID],
    notification: {
      id: `type_test_${Date.now()}`,
      title: 'Notifica√ß√£o Direcionada (Type Alterado)',
      message: 'Mesma notifica√ß√£o, mas com type diferente!',
      type: 'new_proposal',
      priority: 'high',
      timestamp: new Date().toISOString(),
      isRead: false
    }
  };

  try {
    const response3 = await axios.post(`${CHAT_API_URL}/api/notifications/send`, typeTestNotification);
    console.log('üìä Resultado:', {
      success: response3.data.success,
      delivered: response3.data.results?.[0]?.delivered,
      notification: {
        id: response3.data.results?.[0]?.notification?.id,
        type: response3.data.results?.[0]?.notification?.type,
        title: response3.data.results?.[0]?.notification?.title
      }
    });
  } catch (error) {
    console.error('‚ùå Erro:', error.message);
  }


  await new Promise(resolve => setTimeout(resolve, 3000));


  console.log('\nüß™ TESTE 4: Notifica√ß√£o limpa sem campos extras');
  const cleanNotification = {
    userIds: [USER_ID],
    notification: {
      id: `clean_${Date.now()}`,
      title: 'Nova Proposta (Limpa)',
      message: 'Proposta sem campos extras',
      type: 'new_proposal',
      timestamp: new Date().toISOString(),
      isRead: false
    }
  };
  try {
    const response4 = await axios.post(`${CHAT_API_URL}/api/notifications/send`, cleanNotification);
    console.log('üìä Resultado:', {
      success: response4.data.success,
      delivered: response4.data.results?.[0]?.delivered,
      notification: {
        id: response4.data.results?.[0]?.notification?.id,
        type: response4.data.results?.[0]?.notification?.type,
        title: response4.data.results?.[0]?.notification?.title
      }
    });
  } catch (error) {
    console.error('‚ùå Erro:', error.message);
  }

  console.log('\nüîç An√°lise:');
  console.log('1. Verifique no frontend quais notifica√ß√µes apareceram');
  console.log('2. Compare os campos entre as que funcionam e n√£o funcionam');
  console.log('3. Verifique no console do navegador se h√° erros de processamento');
  console.log('4. Todas devem ter delivered: true se chegaram ao WebSocket');
}

debugNotifications();
