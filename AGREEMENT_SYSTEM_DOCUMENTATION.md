# Sistema de Acordos (Agreement System)

## **Problema Resolvido**

**Problema Original:** Finalizar um pedido interferia quando o cliente aceitava outra proposta do mesmo booster.

**Causa:** Model `AcceptedProposal` tinha constraint `unique: true` no `conversationId`, permitindo apenas uma proposta por conversa.

## **Solu√ß√£o Implementada**

### **üèóÔ∏è Nova Arquitetura**

1. **Entidade Agreement Independente**
   - Cada proposta aceita = um Agreement √∫nico
   - Ciclo de vida pr√≥prio: `pending ‚Üí active ‚Üí completed|cancelled|expired`
   - M√∫ltiplos Agreements por conversa permitidos
   - Chave √∫nica: `agreementId` (formato: `AGR_[timestamp]_[random]`)

2. **Desacoplamento Total**
   - Acordo pai vs acordos independentes
   - Finalizar um acordo n√£o afeta outros
   - Controle de vers√£o com optimistic locking
   - Idempot√™ncia em todas opera√ß√µes cr√≠ticas

### **üîÑ Migra√ß√£o Retrocompat√≠vel**

- **AcceptedProposal** mantido para compatibilidade
- Migra√ß√£o autom√°tica em endpoints existentes
- Contratos externos n√£o quebram
- Transi√ß√£o transparente para clients

---

## **Estrutura de Dados**

### **Agreement Schema**

```javascript
{

  agreementId: "AGR_1640995200000_abc123xyz",
  conversationId: ObjectId,
  proposalId: ObjectId,
  acceptedProposalId: ObjectId,
  

  proposalSnapshot: {
    game: "League of Legends",
    category: "Elo Boost", 
    price: 150,
    estimatedTime: "3 dias",

  },
  

  parties: {
    client: { userid, name, email, metadata },
    booster: { userid, name, rating, metadata }
  },
  

  status: "active",
  version: 1,
  

  actionHistory: [{
    action: "created",
    performedBy: ObjectId,
    performedAt: Date,
    idempotencyKey: "migration_abc123"
  }],
  

  financial: {
    totalAmount: 150,
    currency: "BRL",
    paymentStatus: "pending"
  }
}
```

---

## **Endpoints**

### **Novos Endpoints (Agreement-based)**

```
POST   /api/agreements/create
GET    /api/agreements/:agreementId  
POST   /api/agreements/:agreementId/complete
POST   /api/agreements/:agreementId/cancel
POST   /api/agreements/:agreementId/renegotiate
GET    /api/agreements/conversation/:conversationId
GET    /api/agreements/user/me
```

### **Headers de Controle**

```
X-Idempotency-Key: unique-operation-key
Content-Type: application/json
```

### **Controle de Vers√£o**

```json
{
  "version": 3,
  "data": { "newPrice": 200 }
}
```

**Response de Conflito:**
```json
{
  "success": false,
  "message": "Conflito de vers√£o",
  "currentVersion": 4,
  "requestedVersion": 3
}
```

---

## **Compatibilidade**

### **Rotas Existentes (Mantidas)**

- `GET /boosting-chat/conversation/:id/proposal` ‚úÖ
- `POST /boosting-chat/conversation/:id/confirm-delivery` ‚úÖ  
- `POST /boosting-chat/conversation/:id/cancel` ‚úÖ
- `POST /boosting-chat/proposal/save` ‚úÖ (Agora cria Agreement)

### **Migra√ß√£o Autom√°tica**

```javascript

const middleware = AgreementMigrationMiddleware.autoMigrate();


GET /boosting-chat/conversation/123/proposal
‚Üí Cria Agreement baseado em AcceptedProposal existente
‚Üí Resposta unificada (legacy + novo formato)
```

### **Resposta Dual**

```json
{
  "success": true,

  "proposal": { 
    "_id": "old_proposal_id",
    "price": 150,
    "status": "active"
  },

  "agreement": {
    "agreementId": "AGR_1640995200000_abc123",
    "status": "active", 
    "version": 1
  }
}
```

---

## **Opera√ß√µes Cr√≠ticas**

### **1. Criar Nova Proposta**

**Antes:** ‚ùå Falha se j√° existir AcceptedProposal
```
Error: "J√° existe uma proposta aceita para esta conversa"
```

**Depois:** ‚úÖ Permite m√∫ltiplas propostas
```javascript
POST /boosting-chat/proposal/save


```

### **2. Finalizar Acordo**

**Antes:** ‚ùå Afetava toda a conversa
```javascript  
acceptedProposal.complete()
```

**Depois:** ‚úÖ Finaliza apenas o acordo espec√≠fico
```javascript
agreement.complete(userId, details, idempotencyKey)

```

### **3. Idempot√™ncia**

```javascript

POST /agreements/AGR_123/complete
Headers: X-Idempotency-Key: complete_123_20231201


{ "success": true, "message": "J√° completado (idempot√™ncia)" }
```

---

## **Cen√°rios de Uso**

### **Cen√°rio 1: Cliente aceita nova proposta do mesmo booster**

1. **Estado inicial:**
   - Conversa j√° tem AcceptedProposal ativo
   - Primeiro acordo em andamento

2. **Nova proposta aceita:**
   ```javascript
   POST /boosting-chat/proposal/save


   ```

3. **Finaliza√ß√£o independente:**
   ```javascript
   POST /agreements/AGR_primeiro/complete
   POST /agreements/AGR_segundo/complete

   ```

### **Cen√°rio 2: Migra√ß√£o autom√°tica**

1. **Estado legacy:** Apenas AcceptedProposal existe
2. **Primeira requisi√ß√£o nova:**
   ```javascript
   GET /boosting-chat/conversation/123/proposal



   ```

---

## **Benef√≠cios**

### **üéØ Resolu√ß√£o do Problema Principal**
- ‚úÖ **M√∫ltiplas propostas permitidas** por conversa
- ‚úÖ **Finaliza√ß√£o independente** de acordos
- ‚úÖ **Zero interfer√™ncia** entre acordos diferentes

### **üîí Seguran√ßa e Confiabilidade** 
- ‚úÖ **Idempot√™ncia** em opera√ß√µes cr√≠ticas
- ‚úÖ **Optimistic locking** previne race conditions  
- ‚úÖ **Controle de vers√£o** detecta conflitos
- ‚úÖ **Hist√≥rico completo** de a√ß√µes

### **üîÑ Compatibilidade Total**
- ‚úÖ **Migra√ß√£o transparente** sem downtime
- ‚úÖ **Contratos existentes** mantidos
- ‚úÖ **Frontend compat√≠vel** com ambos formatos
- ‚úÖ **Rollback poss√≠vel** se necess√°rio

### **üìà Escalabilidade**
- ‚úÖ **Performance otimizada** com √≠ndices espec√≠ficos
- ‚úÖ **Cache eficiente** por agreement_id
- ‚úÖ **Queries paralelas** para m√∫ltiplos acordos

---

## **Status da Implementa√ß√£o**

- ‚úÖ **Agreement Model** criado
- ‚úÖ **AgreementController** implementado  
- ‚úÖ **Middleware de migra√ß√£o** criado
- ‚úÖ **Routes configuradas** 
- ‚úÖ **BoostingChatController** atualizado
- ‚úÖ **Migra√ß√£o autom√°tica** ativa
- ‚úÖ **Retrocompatibilidade** garantida

**Sistema pronto para produ√ß√£o!** üöÄ
