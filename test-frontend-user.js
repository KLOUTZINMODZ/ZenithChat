/**
 * Teste para notifica√ß√µes usando o user ID real do frontend
 */

const axios = require('axios');
const jwt = require('jsonwebtoken');

const CHAT_API_URL = 'https://12zku8.instatunnel.my/';

console.log('üß™ Testando notifica√ß√µes com user ID real do frontend...');

async function testWithRealUserId() {
  try {
    console.log('üìã Instru√ß√µes:');
    console.log('1. Abra o console do navegador no frontend');
    console.log('2. Execute: localStorage.getItem("token")');
    console.log('3. Cole o token abaixo quando solicitado');
    console.log('');


    const commonUserIds = [
      '675c123456789012345abcde',
      '675c987654321098765edcba',
      'user_123',
      'test_user_123'
    ];

    for (const userId of commonUserIds) {
      console.log(`\nüì® Enviando notifica√ß√£o para user ID: ${userId}`);
      
      try {
        const response = await axios.post(`${CHAT_API_URL}/api/notifications/send`, {
          userIds: [userId],
          notification: {
            id: `test_${Date.now()}_${userId}`,
            title: `Teste para ${userId}`,
            message: `Esta √© uma notifica√ß√£o de teste para o usu√°rio ${userId}`,
            type: 'test',
            priority: 'high',
            timestamp: new Date().toISOString(),
            isRead: false
          }
        });

        console.log(`‚úÖ Resposta para ${userId}:`, {
          success: response.data.success,
          delivered: response.data.results?.[0]?.delivered,
          userId: response.data.results?.[0]?.userId
        });

        if (response.data.results?.[0]?.delivered) {
          console.log('üéâ SUCESSO! Notifica√ß√£o entregue via WebSocket!');
        }

      } catch (error) {
        console.log(`‚ùå Erro para ${userId}:`, error.response?.data?.message || error.message);
      }


      await new Promise(resolve => setTimeout(resolve, 1000));
    }

    console.log('\nüîç Verificando conex√µes WebSocket ativas...');
    
    try {
      const healthResponse = await axios.get(`${CHAT_API_URL}/health`);
      console.log('üè• Status do servidor:', healthResponse.data);
    } catch (error) {
      console.log('‚ùå Erro ao verificar status:', error.message);
    }

    console.log('\nüì± Instru√ß√µes finais:');
    console.log('1. Se alguma notifica√ß√£o foi "delivered: true", ela deve aparecer no frontend');
    console.log('2. Verifique o console do navegador para ver logs de WebSocket');
    console.log('3. Se nenhuma foi entregue, o user ID do frontend √© diferente dos testados');

  } catch (error) {
    console.error('‚ùå Erro geral no teste:', error.message);
  }
}


async function testSpecificUserId(userId) {
  if (!userId) {
    console.log('‚ùå User ID n√£o fornecido');
    return;
  }

  console.log(`\nüéØ Testando com user ID espec√≠fico: ${userId}`);
  
  try {
    const response = await axios.post(`${CHAT_API_URL}/api/notifications/send`, {
      userIds: [userId],
      notification: {
        id: `specific_${Date.now()}`,
        title: 'Notifica√ß√£o Direcionada',
        message: 'Esta notifica√ß√£o foi enviada para seu user ID espec√≠fico!',
        type: 'targeted_test',
        priority: 'high',
        timestamp: new Date().toISOString(),
        isRead: false
      }
    });

    console.log('‚úÖ Resultado:', response.data);
    
    if (response.data.results?.[0]?.delivered) {
      console.log('üéâ Notifica√ß√£o entregue com sucesso via WebSocket!');
    } else {
      console.log('‚ö†Ô∏è Notifica√ß√£o enviada mas n√£o entregue (usu√°rio offline)');
    }

  } catch (error) {
    console.error('‚ùå Erro:', error.response?.data || error.message);
  }
}


const specificUserId = process.argv[2];
if (specificUserId) {
  testSpecificUserId(specificUserId);
} else {
  testWithRealUserId();
}
