const mongoose = require('mongoose');
require('dotenv').config();

const Agreement = require('./src/models/Agreement');
const AcceptedProposal = require('./src/models/AcceptedProposal');
const Conversation = require('./src/models/Conversation');
const User = require('./src/models/User');

// Conversa espec√≠fica com problema
const CONVERSATION_ID = process.argv[2] || '68eede1f766cc53fdff40749';

async function createAgreementForConversation() {
  try {
    await mongoose.connect(process.env.MONGODB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true
    });
    
    console.log('‚úÖ Conectado ao MongoDB');
    console.log(`üîç Criando Agreement para conversa: ${CONVERSATION_ID}\n`);
    
    // Buscar conversa
    const conv = await Conversation.findById(CONVERSATION_ID);
    
    if (!conv) {
      console.error(`‚ùå Conversa n√£o encontrada: ${CONVERSATION_ID}`);
      process.exit(1);
    }
    
    console.log('‚úÖ Conversa encontrada:');
    console.log(`   _id: ${conv._id}`);
    console.log(`   type: ${conv.type}`);
    console.log(`   isTemporary: ${conv.isTemporary}`);
    console.log(`   status: ${conv.status}`);
    console.log(`   boostingStatus: ${conv.boostingStatus}`);
    console.log(`   participants: ${conv.participants?.join(', ')}`);
    
    const metadata = conv.metadata instanceof Map 
      ? Object.fromEntries(conv.metadata) 
      : (conv.metadata || {});
    
    console.log(`   metadata:`, JSON.stringify(metadata, null, 2));
    console.log('');
    
    // Verificar se j√° existe Agreement
    const existingAgreement = await Agreement.findOne({ conversationId: CONVERSATION_ID });
    
    if (existingAgreement) {
      console.log(`‚úÖ Agreement J√Å EXISTE: ${existingAgreement.agreementId}`);
      console.log(`   Status: ${existingAgreement.status}`);
      console.log(`   Price: R$ ${existingAgreement.proposalSnapshot?.price}`);
      console.log('\nüí° N√£o √© necess√°rio criar novo Agreement.');
      process.exit(0);
    }
    
    console.log('üìù Agreement N√ÉO existe, criando...\n');
    
    // Buscar AcceptedProposal se existir
    const acceptedProposal = await AcceptedProposal.findOne({ conversationId: CONVERSATION_ID });
    
    if (acceptedProposal) {
      console.log('‚úÖ AcceptedProposal encontrado:');
      console.log(`   client.userid: ${acceptedProposal.client?.userid}`);
      console.log(`   booster.userid: ${acceptedProposal.booster?.userid}`);
      console.log(`   price: ${acceptedProposal.price}`);
      console.log('');
    }
    
    // Identificar participantes
    const participants = conv.participants || [];
    
    let clientId = metadata.clientId || acceptedProposal?.client?.userid || participants[0];
    let boosterId = metadata.boosterId || acceptedProposal?.booster?.userid || participants[1];
    
    console.log('üîç IDs identificados:');
    console.log(`   clientId: ${clientId}`);
    console.log(`   boosterId: ${boosterId}`);
    console.log('');
    
    // Buscar usu√°rios
    const clientUser = await User.findById(clientId);
    const boosterUser = await User.findById(boosterId);
    
    if (!clientUser) {
      console.error(`‚ùå Cliente n√£o encontrado: ${clientId}`);
      console.log('\nüí° Tente fornecer o clientId correto manualmente.');
      process.exit(1);
    }
    
    if (!boosterUser) {
      console.error(`‚ùå Booster n√£o encontrado: ${boosterId}`);
      console.log('\nüí° Tente fornecer o boosterId correto manualmente.');
      process.exit(1);
    }
    
    console.log('‚úÖ Usu√°rios encontrados:');
    console.log(`   Client: ${clientUser.name} (${clientUser.email})`);
    console.log(`   Booster: ${boosterUser.name} (${boosterUser.email})`);
    console.log('');
    
    // Extrair dados da proposta (pode estar em metadata.proposalData)
    const proposalData = metadata.proposalData || {};
    const proposalId = metadata.proposalId || metadata.actualProposalId || conv.proposal || conv._id;
    const proposalPrice = proposalData.price || acceptedProposal?.price || metadata.price || metadata.proposedPrice || 300;
    
    console.log('üìã Dados da proposta:');
    console.log(`   proposalId: ${proposalId}`);
    console.log(`   price: R$ ${proposalPrice}`);
    console.log(`   game: ${proposalData.game || metadata.game || 'N/A'}`);
    console.log(`   category: ${proposalData.category || metadata.category || 'Boosting'}`);
    console.log(`   description: ${proposalData.description || metadata.description || 'N/A'}`);
    console.log('');
    
    if (!proposalPrice || proposalPrice <= 0) {
      console.error(`‚ùå Pre√ßo inv√°lido: ${proposalPrice}`);
      console.log('\nüí° Forne√ßa um pre√ßo v√°lido manualmente.');
      process.exit(1);
    }
    
    // Criar Agreement
    console.log('üöÄ Criando Agreement...\n');
    
    const agreement = new Agreement({
      conversationId: conv._id,
      proposalId: mongoose.Types.ObjectId.isValid(proposalId) ? proposalId : conv._id,
      proposalSnapshot: {
        game: proposalData.game || metadata.game || 'N/A',
        category: proposalData.category || metadata.category || metadata.boostingCategory || 'Boosting',
        currentRank: proposalData.currentRank || metadata.currentRank || 'N/A',
        desiredRank: proposalData.desiredRank || metadata.desiredRank || 'N/A',
        description: proposalData.description || metadata.description || proposalData.message || metadata.message || 'Servi√ßo de boosting',
        price: proposalPrice,
        originalPrice: proposalPrice,
        estimatedTime: proposalData.estimatedTime || metadata.estimatedTime || '1 hora'
      },
      parties: {
        client: {
          userid: clientId,
          name: clientUser.name || clientUser.username,
          email: clientUser.email,
          avatar: clientUser.avatar,
          metadata: new Map([
            ['isVerified', clientUser.isVerified || false],
            ['totalOrders', clientUser.totalOrders || 0],
            ['rating', clientUser.rating || 0]
          ])
        },
        booster: {
          userid: boosterId,
          name: boosterUser.name || boosterUser.username,
          email: boosterUser.email,
          avatar: boosterUser.avatar,
          rating: boosterUser.rating || 0,
          metadata: new Map([
            ['isVerified', boosterUser.isVerified || false],
            ['totalBoosts', boosterUser.totalBoosts || 0],
            ['completedBoosts', boosterUser.completedBoosts || 0]
          ])
        }
      },
      financial: {
        totalAmount: proposalPrice,
        currency: 'BRL',
        paymentStatus: 'pending'
      },
      status: conv.boostingStatus === 'completed' ? 'completed' : 'active'
    });
    
    agreement.addAction('created', clientId, { 
      proposalId: proposalId,
      manuallyCreated: true,
      createdAt: new Date()
    });
    
    // Se j√° foi completado, adicionar action
    if (conv.boostingStatus === 'completed') {
      agreement.addAction('completed', clientId, {
        completedAt: conv.deliveryConfirmedAt || new Date(),
        manualCompletion: true
      });
    }
    
    await agreement.save();
    
    // Atualizar conversa com agreementId
    conv.metadata = conv.metadata || new Map();
    if (conv.metadata instanceof Map) {
      conv.metadata.set('latestAgreementId', agreement.agreementId);
    } else {
      conv.metadata.latestAgreementId = agreement.agreementId;
    }
    await conv.save();
    
    console.log('=' .repeat(80));
    console.log('‚úÖ AGREEMENT CRIADO COM SUCESSO!');
    console.log('='.repeat(80));
    console.log(`   agreementId: ${agreement.agreementId}`);
    console.log(`   conversationId: ${agreement.conversationId}`);
    console.log(`   proposalId: ${agreement.proposalId}`);
    console.log(`   status: ${agreement.status}`);
    console.log(`   price: R$ ${agreement.proposalSnapshot.price}`);
    console.log(`   client: ${agreement.parties.client.name}`);
    console.log(`   booster: ${agreement.parties.booster.name}`);
    console.log('='.repeat(80));
    console.log('\nüí° Agora voc√™ pode confirmar a entrega normalmente!');
    console.log('\nTestar com:');
    console.log(`curl -X POST https://zenith.enrelyugi.com.br/api/boosting-chat/conversation/${CONVERSATION_ID}/confirm-delivery -H "Authorization: Bearer TOKEN"`);
    
  } catch (error) {
    console.error('‚ùå Erro fatal:', error.message);
    console.error(error.stack);
  } finally {
    await mongoose.disconnect();
    console.log('\n‚úÖ Desconectado do MongoDB');
  }
}

createAgreementForConversation();
