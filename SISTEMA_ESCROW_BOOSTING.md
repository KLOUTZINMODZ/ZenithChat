# üí∞ Sistema de Escrow para Boosting

**Data:** 15/10/2025  
**Status:** ‚úÖ **IMPLEMENTADO**

---

## üéØ Objetivo

Implementar **sistema de escrow** para boosting, onde:
1. ‚úÖ Cliente √© **debitado IMEDIATAMENTE** ao aceitar proposta
2. ‚úÖ Valor fica **retido (escrow)** at√© confirma√ß√£o de entrega
3. ‚úÖ Ao confirmar entrega, valor √© **liberado** para booster e mediador
4. ‚úÖ Cliente **N√ÉO pode cancelar** sem reembolso ap√≥s aceitar

**Id√™ntico ao Marketplace!** üîÑ

---

## üìä Fluxo: Antes vs Depois

### **ANTES (Sem Escrow):**

```
1. Cliente aceita proposta
   ‚îî‚îÄ Saldo: R$ 1000 (nada muda)

2. Cliente confirma entrega
   ‚îî‚îÄ Saldo: R$ 1000 ‚Üí R$ 700 ‚ùå (debitado tarde demais)
```

**Problema:** Cliente pode aceitar proposta sem saldo suficiente!

---

### **DEPOIS (Com Escrow):**

```
1. Cliente aceita proposta
   ‚îú‚îÄ Verificar saldo suficiente ‚úÖ
   ‚îú‚îÄ Saldo: R$ 1000 ‚Üí R$ 700 (debitado imediatamente)
   ‚îî‚îÄ Status: "escrowed" (valor retido)

2. Cliente confirma entrega
   ‚îú‚îÄ Saldo: R$ 700 (n√£o muda - j√° foi debitado)
   ‚îú‚îÄ Booster: +R$ 285 (95%)
   ‚îî‚îÄ Mediador: +R$ 15 (5%)
```

**Vantagem:** Cliente precisa ter saldo antes de aceitar!

---

## üîß Implementa√ß√£o

### **1. Aceitar Proposta (com Escrow)**

**Arquivo:** `src/routes/proposalRoutes.js` (linhas 375-438)

```javascript
// ‚úÖ NOVO: DEBITAR cliente imediatamente (ESCROW) ao aceitar proposta
try {
  console.log('üí∞ [Proposal Accept] Debitando cliente (escrow)...');
  
  const User = require('../models/User');
  const WalletLedger = require('../models/WalletLedger');
  const round2 = (n) => Math.round((n + Number.EPSILON) * 100) / 100;
  
  // Buscar cliente para verificar saldo
  const clientForDebit = await User.findById(clientId);
  const clientBalanceBefore = round2(clientForDebit.walletBalance || 0);
  
  // ‚ö†Ô∏è Verificar saldo suficiente
  if (clientBalanceBefore < proposalPrice) {
    throw new Error(`Saldo insuficiente. Necess√°rio: R$ ${proposalPrice.toFixed(2)}, Dispon√≠vel: R$ ${clientBalanceBefore.toFixed(2)}`);
  }
  
  // Debitar cliente
  const clientBalanceAfter = round2(clientBalanceBefore - proposalPrice);
  clientForDebit.walletBalance = clientBalanceAfter;
  await clientForDebit.save();
  
  // Criar registro no WalletLedger (escrow)
  await WalletLedger.create({
    userId: clientId,
    direction: 'debit',
    reason: 'boosting_escrow', // ‚úÖ NOVO
    amount: proposalPrice,
    operationId: `boosting_escrow:${agreement._id}`,
    balanceBefore: clientBalanceBefore,
    balanceAfter: clientBalanceAfter,
    metadata: {
      source: 'boosting',
      agreementId: agreement._id.toString(),
      conversationId: conversationId,
      boosterId: boosterId.toString(),
      price: Number(proposalPrice),
      feePercent: 0.05,
      type: 'boosting_service',
      serviceName: 'Servi√ßo de Boosting',
      providerName: boosterUser.name || 'Booster',
      status: 'escrowed' // ‚úÖ Indica que est√° em escrow
    }
  });
  
  // Atualizar Agreement
  agreement.financial.paymentStatus = 'escrowed';
  await agreement.save();
  
  console.log('‚úÖ [Proposal Accept] Cliente debitado (escrow)');
} catch (escrowError) {
  // Se falhar, reverter Agreement
  await Agreement.deleteOne({ _id: agreement._id });
  throw new Error(`Erro ao processar pagamento: ${escrowError.message}`);
}
```

---

### **2. Confirmar Entrega (Liberar Escrow)**

**Arquivo:** `src/controllers/boostingChatController.js` (linhas 554-655)

```javascript
// 1. VERIFICAR se cliente j√° foi debitado (escrow)
const existingEscrow = await WalletLedger.findOne({
  userId: clientUserId,
  reason: 'boosting_escrow',
  'metadata.agreementId': agreement?._id?.toString()
}).session(session);

if (existingEscrow) {
  // ‚úÖ Cliente J√Å FOI DEBITADO no escrow (novo fluxo)
  console.log('[BOOSTING] Cliente j√° foi debitado no escrow');
  
  // Apenas registrar a libera√ß√£o do escrow (n√£o altera saldo)
  const clientUser = await User.findById(clientUserId).session(session);
  const clientBalanceBefore = round2(clientUser.walletBalance || 0);
  const clientBalanceAfter = clientBalanceBefore; // ‚úÖ Saldo N√ÉO muda
  
  // Criar registro de libera√ß√£o
  await WalletLedger.create([{
    userId: clientUserId,
    direction: 'debit',
    reason: 'boosting_escrow_release', // ‚úÖ NOVO
    amount: 0, // ‚úÖ Zero porque j√° foi debitado
    operationId: `boosting_escrow_release:${agreement._id}`,
    balanceBefore: clientBalanceBefore,
    balanceAfter: clientBalanceAfter,
    metadata: {
      source: 'boosting',
      agreementId: agreement._id.toString(),
      price: Number(price),
      feeAmount: Number(feeAmount),
      boosterReceives: Number(boosterReceives),
      status: 'released', // ‚úÖ Escrow liberado
      originalEscrowId: existingEscrow._id.toString()
    }
  }], { session });
  
  console.log('[BOOSTING] Escrow liberado (saldo n√£o alterado)');
} else {
  // ‚ö†Ô∏è Fluxo legado: debitar agora (boostings antigos sem escrow)
  console.warn('[BOOSTING] Cliente N√ÉO foi debitado no escrow, debitando agora');
  
  const clientUser = await User.findById(clientUserId).session(session);
  const clientBalanceBefore = round2(clientUser.walletBalance || 0);
  
  if (clientBalanceBefore < price) {
    throw new Error(`Saldo insuficiente. Necess√°rio: R$ ${price.toFixed(2)}`);
  }
  
  const clientBalanceAfter = round2(clientBalanceBefore - price);
  clientUser.walletBalance = clientBalanceAfter;
  await clientUser.save({ session });
  
  await WalletLedger.create([{
    userId: clientUserId,
    direction: 'debit',
    reason: 'boosting_payment', // ‚úÖ Fluxo legado
    amount: price,
    operationId: `boosting_payment:${agreement._id}`,
    balanceBefore: clientBalanceBefore,
    balanceAfter: clientBalanceAfter,
    metadata: { /* ... */ }
  }], { session });
}

// 2. Creditar booster (95%)
// 3. Creditar mediador (5%)
// ... resto do fluxo
```

---

### **3. WalletLedger Model (Novos Reasons)**

**Arquivo:** `src/models/WalletLedger.js` (linhas 23-27)

```javascript
reason: { type: String, enum: [
  'withdraw_reserve',
  'withdraw_refund',
  'withdraw_settle',
  'deposit_credit',
  'deposit_revert',
  'adjustment',
  'purchase_reserve',
  'purchase_refund',
  'purchase_release',
  'purchase_fee',
  'purchase_settle',
  'boosting_escrow',         // ‚úÖ NOVO: Cliente debitado ao aceitar
  'boosting_escrow_release',  // ‚úÖ NOVO: Escrow liberado ao confirmar
  'boosting_payment',         // ‚úÖ NOVO: Fluxo legado (sem escrow)
  'boosting_release',
  'boosting_fee'
], required: true }
```

---

## üìä Estrutura dos Registros

### **Escrow (Aceitar Proposta):**

```javascript
{
  userId: clientId,
  direction: 'debit',
  reason: 'boosting_escrow', // ‚úÖ NOVO
  amount: 300.00,
  balanceBefore: 1000.00,
  balanceAfter: 700.00, // ‚úÖ Saldo reduzido imediatamente
  metadata: {
    source: 'boosting',
    agreementId: "...",
    conversationId: "...",
    boosterId: "...",
    price: 300,
    feePercent: 0.05,
    type: 'boosting_service',
    serviceName: 'Servi√ßo de Boosting',
    providerName: 'Nome do Booster',
    status: 'escrowed' // ‚úÖ Indica escrow ativo
  }
}
```

---

### **Libera√ß√£o do Escrow (Confirmar Entrega):**

```javascript
{
  userId: clientId,
  direction: 'debit',
  reason: 'boosting_escrow_release', // ‚úÖ NOVO
  amount: 0, // ‚úÖ Zero (j√° foi debitado no escrow)
  balanceBefore: 700.00,
  balanceAfter: 700.00, // ‚úÖ Saldo N√ÉO muda
  metadata: {
    source: 'boosting',
    agreementId: "...",
    price: 300,
    feeAmount: 15,
    boosterReceives: 285,
    status: 'released', // ‚úÖ Escrow liberado
    originalEscrowId: "..." // ‚úÖ Refer√™ncia ao escrow original
  }
}
```

---

## üîÑ Compatibilidade com Fluxo Legado

O sistema √© **retrocompat√≠vel** com boostings antigos:

```javascript
// Se N√ÉO encontrar escrow ‚Üí Usar fluxo legado
if (!existingEscrow) {
  console.warn('[BOOSTING] Fluxo legado: debitando cliente agora');
  
  // Debitar cliente normalmente
  clientUser.walletBalance -= price;
  await clientUser.save({ session });
  
  await WalletLedger.create([{
    reason: 'boosting_payment', // Fluxo legado
    amount: price,
    // ...
  }], { session });
}
```

**Benef√≠cio:** Boostings antigos continuam funcionando!

---

## ‚úÖ Vantagens do Sistema de Escrow

### **1. Seguran√ßa Financeira**
- ‚úÖ Cliente s√≥ pode aceitar se tiver saldo
- ‚úÖ Imposs√≠vel aceitar proposta sem dinheiro
- ‚úÖ Valor fica garantido para o booster

### **2. Prote√ß√£o ao Booster**
- ‚úÖ Pagamento garantido antes de come√ßar o servi√ßo
- ‚úÖ Cliente n√£o pode "fugir" depois de aceitar
- ‚úÖ Reduz inadimpl√™ncia

### **3. Transpar√™ncia**
- ‚úÖ Cliente v√™ d√©bito imediatamente ao aceitar
- ‚úÖ Hist√≥rico completo no WalletLedger
- ‚úÖ Rastreamento do escrow

### **4. Consist√™ncia**
- ‚úÖ **Id√™ntico ao Marketplace** (purchase_reserve)
- ‚úÖ Mesmos princ√≠pios e fluxos
- ‚úÖ C√≥digo unificado

---

## üß™ Como Testar

### **Teste 1: Aceitar Proposta (Com Saldo)**

```
1. Cliente com R$ 1000
2. Aceitar proposta de R$ 300
3. Verificar:
   ‚úÖ Saldo: R$ 1000 ‚Üí R$ 700
   ‚úÖ WalletLedger: reason='boosting_escrow', amount=300
   ‚úÖ Agreement: paymentStatus='escrowed'
```

---

### **Teste 2: Aceitar Proposta (Sem Saldo)**

```
1. Cliente com R$ 100
2. Tentar aceitar proposta de R$ 300
3. Verificar:
   ‚ùå Erro: "Saldo insuficiente"
   ‚ùå Proposta N√ÉO aceita
   ‚ùå Agreement N√ÉO criado
```

---

### **Teste 3: Confirmar Entrega (Com Escrow)**

```
1. Cliente aceita proposta (R$ 300)
   ‚îî‚îÄ Saldo: R$ 1000 ‚Üí R$ 700

2. Cliente confirma entrega
3. Verificar:
   ‚úÖ Cliente: R$ 700 (n√£o muda)
   ‚úÖ Booster: +R$ 285
   ‚úÖ Mediador: +R$ 15
   ‚úÖ WalletLedger: reason='boosting_escrow_release', amount=0
```

---

### **Teste 4: Confirmar Entrega (Fluxo Legado)**

```
1. Boosting antigo (sem escrow)
2. Cliente confirma entrega
3. Verificar:
   ‚úÖ Cliente: R$ 1000 ‚Üí R$ 700 (debitado agora)
   ‚úÖ Booster: +R$ 285
   ‚úÖ Mediador: +R$ 15
   ‚úÖ WalletLedger: reason='boosting_payment', amount=300
```

---

## üìã Verifica√ß√£o no MongoDB

### **1. Verificar Escrow Criado:**

```javascript
// Escrows ativos
db.walletledgers.find({
  reason: 'boosting_escrow'
}).sort({ createdAt: -1 })

// Deve ter:
// - amount > 0
// - balanceBefore > balanceAfter
// - metadata.status: 'escrowed'
```

---

### **2. Verificar Libera√ß√£o de Escrow:**

```javascript
// Escrows liberados
db.walletledgers.find({
  reason: 'boosting_escrow_release'
}).sort({ createdAt: -1 })

// Deve ter:
// - amount: 0
// - balanceBefore === balanceAfter
// - metadata.status: 'released'
// - metadata.originalEscrowId: (ref ao escrow)
```

---

### **3. Verificar Agreement:**

```javascript
// Agreements com escrow
db.agreements.find({
  'financial.paymentStatus': 'escrowed'
})

// Deve ter paymentStatus = 'escrowed'
```

---

## ‚ö†Ô∏è Regras Importantes

### **1. Cancelamento**
Se cliente cancelar ap√≥s aceitar:
- ‚ö†Ô∏è **PRECISA IMPLEMENTAR REEMBOLSO**
- Valor est√° em escrow (j√° foi debitado)
- N√£o pode simplesmente "desfazer" Agreement

```javascript
// TODO: Implementar cancelamento com reembolso
async function cancelWithRefund(agreementId) {
  const escrow = await WalletLedger.findOne({
    reason: 'boosting_escrow',
    'metadata.agreementId': agreementId
  });
  
  if (escrow) {
    // Reembolsar cliente
    clientUser.walletBalance += escrow.amount;
    
    // Criar registro de reembolso
    await WalletLedger.create({
      userId: clientId,
      direction: 'credit',
      reason: 'boosting_escrow_refund',
      amount: escrow.amount,
      // ...
    });
  }
}
```

---

### **2. Timeout/Expira√ß√£o**
Se boosting expirar sem confirma√ß√£o:
- ‚ö†Ô∏è **PRECISA REEMBOLSAR AUTOMATICAMENTE**
- N√£o pode deixar dinheiro preso

```javascript
// TODO: Implementar job de expira√ß√£o
cron.schedule('0 * * * *', async () => {
  const expiredAgreements = await Agreement.find({
    'financial.paymentStatus': 'escrowed',
    expiresAt: { $lt: new Date() }
  });
  
  for (const agreement of expiredAgreements) {
    await cancelWithRefund(agreement._id);
  }
});
```

---

## üéØ Compara√ß√£o com Marketplace

| Aspecto | Marketplace | Boosting | Status |
|---------|-------------|----------|--------|
| **Escrow ao aceitar?** | ‚úÖ Sim (purchase_reserve) | ‚úÖ Sim (boosting_escrow) | ‚úÖ Id√™ntico |
| **Verificar saldo?** | ‚úÖ Sim | ‚úÖ Sim | ‚úÖ Id√™ntico |
| **Libera√ß√£o ao confirmar?** | ‚úÖ Sim (purchase_release) | ‚úÖ Sim (boosting_escrow_release) | ‚úÖ Id√™ntico |
| **Taxa 5%?** | ‚úÖ Sim (purchase_fee) | ‚úÖ Sim (boosting_fee) | ‚úÖ Id√™ntico |
| **Reembolso ao cancelar?** | ‚úÖ Sim (purchase_refund) | ‚ö†Ô∏è TODO | ‚ùå Falta |
| **Expira√ß√£o autom√°tica?** | ‚úÖ Sim | ‚ö†Ô∏è TODO | ‚ùå Falta |

---

## ‚úÖ Checklist Final

### **Implementado:**
- [x] Cliente debitado ao aceitar proposta
- [x] Verifica√ß√£o de saldo suficiente
- [x] WalletLedger com reason='boosting_escrow'
- [x] Agreement com paymentStatus='escrowed'
- [x] Libera√ß√£o de escrow ao confirmar entrega
- [x] WalletLedger com reason='boosting_escrow_release'
- [x] Compatibilidade com fluxo legado
- [x] Booster creditado (95%)
- [x] Mediador creditado (5%)

### **Pendente:**
- [ ] Reembolso ao cancelar proposta
- [ ] Expira√ß√£o autom√°tica de escrow
- [ ] Frontend: mostrar "Valor em escrow"
- [ ] Notifica√ß√£o ao cliente sobre d√©bito

---

**Status:** ‚úÖ **SISTEMA DE ESCROW IMPLEMENTADO**

**Pr√≥xima a√ß√£o:** üî¥ **REINICIAR CHAT API E TESTAR ACEITAR PROPOSTA!**

---

**NOTA:** Agora o sistema de Boosting funciona **exatamente** como o Marketplace, garantindo pagamentos seguros e transparentes! üéâ

