require('dotenv').config();
const fs = require('fs');

console.log('üîç AN√ÅLISE COMPLETA DO FLUXO: MARKETPLACE VS BOOSTING\n');
console.log('=' .repeat(80));

// 1. Verificar configura√ß√£o .env
console.log('\nüìã 1. CONFIGURA√á√ÉO (.env):');
console.log('-'.repeat(80));
console.log('  MEDIATOR_EMAIL:', process.env.MEDIATOR_EMAIL || '‚ùå N√ÉO CONFIGURADO');
if (!process.env.MEDIATOR_EMAIL) {
  console.log('  ‚ùå PROBLEMA: Email do mediador n√£o configurado!');
} else {
  console.log('  ‚úÖ Email configurado');
}

// 2. Verificar Model WalletLedger
console.log('\nüìã 2. MODEL WALLETLEDGER (Enum "reason"):');
console.log('-'.repeat(80));

const walletLedgerPath = './src/models/WalletLedger.js';
const walletLedgerContent = fs.readFileSync(walletLedgerPath, 'utf8');

const reasonMatch = walletLedgerContent.match(/reason:\s*{\s*type:\s*String,\s*enum:\s*\[([\s\S]*?)\]/);
if (reasonMatch) {
  const reasons = reasonMatch[1]
    .split(',')
    .map(r => r.trim().replace(/['"]/g, ''))
    .filter(r => r);
  
  console.log('  Enums encontrados:');
  reasons.forEach(r => console.log(`    - ${r}`));
  
  const requiredReasons = [
    'purchase_fee',
    'purchase_release',
    'boosting_fee',
    'boosting_release',
    'boosting_escrow',
    'boosting_escrow_release'
  ];
  
  console.log('\n  Verificando enums necess√°rios:');
  requiredReasons.forEach(req => {
    const exists = reasons.includes(req);
    console.log(`    ${exists ? '‚úÖ' : '‚ùå'} ${req}`);
  });
} else {
  console.log('  ‚ùå N√£o foi poss√≠vel extrair enum do modelo!');
}

// 3. Verificar Model Agreement
console.log('\nüìã 3. MODEL AGREEMENT (Enum "paymentStatus"):');
console.log('-'.repeat(80));

const agreementPath = './src/models/Agreement.js';
const agreementContent = fs.readFileSync(agreementPath, 'utf8');

const paymentStatusMatch = agreementContent.match(/paymentStatus:\s*{\s*type:\s*String,\s*enum:\s*\[([\s\S]*?)\]/);
if (paymentStatusMatch) {
  const statuses = paymentStatusMatch[1]
    .split(',')
    .map(s => s.trim().replace(/['"]/g, ''))
    .filter(s => s);
  
  console.log('  Enums encontrados:');
  statuses.forEach(s => console.log(`    - ${s}`));
  
  const hasEscrowed = statuses.includes('escrowed');
  console.log(`\n  ${hasEscrowed ? '‚úÖ' : '‚ùå'} Enum "escrowed" ${hasEscrowed ? 'presente' : 'ausente'}`);
} else {
  console.log('  ‚ùå N√£o foi poss√≠vel extrair enum do modelo!');
}

// 4. Analisar fluxo do Marketplace
console.log('\nüìã 4. FLUXO DO MARKETPLACE (purchasesRoutes.js):');
console.log('-'.repeat(80));

const purchasesPath = './src/routes/purchasesRoutes.js';
const purchasesContent = fs.readFileSync(purchasesPath, 'utf8');

// Verificar se credita vendedor
const hasSellerCredit = purchasesContent.includes('seller.walletBalance = after');
console.log(`  ${hasSellerCredit ? '‚úÖ' : '‚ùå'} Credita vendedor (95%)`);

// Verificar se credita mediador
const hasMediatorCredit = purchasesContent.includes('mediatorUser.walletBalance = medAfter');
console.log(`  ${hasMediatorCredit ? '‚úÖ' : '‚ùå'} Credita mediador (5%)`);

// Verificar busca do mediador
const searchByEmail = purchasesContent.includes('User.findOne({ email: envEmail })') ||
                      purchasesContent.includes('User.findOne({ email: mediatorEmail })');
console.log(`  ${searchByEmail ? '‚úÖ' : '‚ùå'} Busca mediador por email`);

// Verificar WalletLedger do vendedor
const hasSellerLedger = purchasesContent.includes("reason: 'purchase_release'");
console.log(`  ${hasSellerLedger ? '‚úÖ' : '‚ùå'} Cria WalletLedger (vendedor - purchase_release)`);

// Verificar WalletLedger do mediador
const hasMediatorLedger = purchasesContent.includes("reason: 'purchase_fee'");
console.log(`  ${hasMediatorLedger ? '‚úÖ' : '‚ùå'} Cria WalletLedger (mediador - purchase_fee)`);

// Verificar Mediator log (release)
const hasMediatorReleaseLog = purchasesContent.includes("eventType: 'release'");
console.log(`  ${hasMediatorReleaseLog ? '‚úÖ' : '‚ùå'} Cria Mediator log (release)`);

// Verificar Mediator log (fee)
const hasMediatorFeeLog = purchasesContent.includes("eventType: 'fee'");
console.log(`  ${hasMediatorFeeLog ? '‚úÖ' : '‚ùå'} Cria Mediator log (fee)`);

// 5. Analisar fluxo do Boosting
console.log('\nüìã 5. FLUXO DO BOOSTING (boostingChatController.js):');
console.log('-'.repeat(80));

const boostingPath = './src/controllers/boostingChatController.js';
const boostingContent = fs.readFileSync(boostingPath, 'utf8');

// Verificar se credita booster
const hasBoosterCredit = boostingContent.includes('boosterUser.walletBalance = boosterBalanceAfter');
console.log(`  ${hasBoosterCredit ? '‚úÖ' : '‚ùå'} Credita booster (95%)`);

// Verificar se credita mediador
const hasBoostingMediatorCredit = boostingContent.includes('mediatorUser.walletBalance = mediatorBalanceAfter');
console.log(`  ${hasBoostingMediatorCredit ? '‚úÖ' : '‚ùå'} Credita mediador (5%)`);

// Verificar busca do mediador
const boostingSearchByEmail = boostingContent.includes('User.findOne({ email: mediatorEmail })');
console.log(`  ${boostingSearchByEmail ? '‚úÖ' : '‚ùå'} Busca mediador por email`);

// Verificar WalletLedger do booster
const hasBoosterLedger = boostingContent.includes("reason: 'boosting_release'");
console.log(`  ${hasBoosterLedger ? '‚úÖ' : '‚ùå'} Cria WalletLedger (booster - boosting_release)`);

// Verificar WalletLedger do mediador
const hasBoostingMediatorLedger = boostingContent.includes("reason: 'boosting_fee'");
console.log(`  ${hasBoostingMediatorLedger ? '‚úÖ' : '‚ùå'} Cria WalletLedger (mediador - boosting_fee)`);

// Verificar Mediator log (release)
const hasBoostingMediatorReleaseLog = boostingContent.includes("eventType: 'release'");
console.log(`  ${hasBoostingMediatorReleaseLog ? '‚úÖ' : '‚ùå'} Cria Mediator log (release)`);

// Verificar Mediator log (fee)
const hasBoostingMediatorFeeLog = boostingContent.includes("eventType: 'fee'");
console.log(`  ${hasBoostingMediatorFeeLog ? '‚úÖ' : '‚ùå'} Cria Mediator log (fee)`);

// Verificar escrow no boosting
const hasEscrowCheck = boostingContent.includes("reason: 'boosting_escrow'");
console.log(`  ${hasEscrowCheck ? '‚úÖ' : '‚ùå'} Verifica escrow (boosting_escrow)`);

const hasEscrowRelease = boostingContent.includes("reason: 'boosting_escrow_release'");
console.log(`  ${hasEscrowRelease ? '‚úÖ' : '‚ùå'} Registra libera√ß√£o de escrow`);

// 6. Compara√ß√£o lado a lado
console.log('\nüìã 6. COMPARA√á√ÉO LADO A LADO:');
console.log('-'.repeat(80));

const comparison = [
  ['Funcionalidade', 'Marketplace', 'Boosting', 'Status'],
  ['-'.repeat(30), '-'.repeat(15), '-'.repeat(15), '-'.repeat(10)],
  ['Credita prestador (95%)', '‚úÖ Vendedor', '‚úÖ Booster', '‚úÖ OK'],
  ['Credita mediador (5%)', '‚úÖ Sim', hasBoostingMediatorCredit ? '‚úÖ Sim' : '‚ùå N√£o', hasBoostingMediatorCredit ? '‚úÖ OK' : '‚ùå ERRO'],
  ['Busca mediador por email', '‚úÖ Sim', boostingSearchByEmail ? '‚úÖ Sim' : '‚ùå N√£o', boostingSearchByEmail ? '‚úÖ OK' : '‚ùå ERRO'],
  ['WalletLedger prestador', '‚úÖ purchase_release', '‚úÖ boosting_release', '‚úÖ OK'],
  ['WalletLedger mediador', '‚úÖ purchase_fee', hasBoostingMediatorLedger ? '‚úÖ boosting_fee' : '‚ùå N√£o', hasBoostingMediatorLedger ? '‚úÖ OK' : '‚ùå ERRO'],
  ['Mediator log (release)', '‚úÖ Sim', hasBoostingMediatorReleaseLog ? '‚úÖ Sim' : '‚ùå N√£o', hasBoostingMediatorReleaseLog ? '‚úÖ OK' : '‚ùå ERRO'],
  ['Mediator log (fee)', '‚úÖ Sim', hasBoostingMediatorFeeLog ? '‚úÖ Sim' : '‚ùå N√£o', hasBoostingMediatorFeeLog ? '‚úÖ OK' : '‚ùå ERRO'],
  ['Sistema de escrow', '‚úÖ Sim', hasEscrowCheck ? '‚úÖ Sim' : '‚ùå N√£o', hasEscrowCheck ? '‚úÖ OK' : '‚ùå ERRO'],
];

comparison.forEach(row => {
  console.log(`  ${row[0].padEnd(30)} | ${row[1].padEnd(15)} | ${row[2].padEnd(15)} | ${row[3]}`);
});

// 7. Verificar se h√° warnings/erros
console.log('\nüìã 7. VERIFICA√á√ÉO DE PROBLEMAS:');
console.log('-'.repeat(80));

const problems = [];

if (!process.env.MEDIATOR_EMAIL) {
  problems.push('‚ùå MEDIATOR_EMAIL n√£o configurado no .env');
}

if (!hasBoostingMediatorCredit) {
  problems.push('‚ùå Boosting n√£o est√° creditando o mediador');
}

if (!boostingSearchByEmail) {
  problems.push('‚ùå Boosting n√£o est√° buscando mediador por email');
}

if (!hasBoostingMediatorLedger) {
  problems.push('‚ùå Boosting n√£o est√° criando WalletLedger do mediador');
}

if (!hasBoostingMediatorFeeLog) {
  problems.push('‚ùå Boosting n√£o est√° criando Mediator log (fee)');
}

if (problems.length === 0) {
  console.log('  ‚úÖ NENHUM PROBLEMA ENCONTRADO!');
  console.log('  ‚úÖ O fluxo est√° 100% correto e id√™ntico ao marketplace!');
} else {
  console.log('  Problemas encontrados:');
  problems.forEach(p => console.log(`    ${p}`));
}

// 8. Resumo final
console.log('\nüìã 8. RESUMO FINAL:');
console.log('-'.repeat(80));

const allChecks = [
  process.env.MEDIATOR_EMAIL,
  hasBoostingMediatorCredit,
  boostingSearchByEmail,
  hasBoostingMediatorLedger,
  hasBoostingMediatorFeeLog,
  hasBoostingMediatorReleaseLog,
  hasEscrowCheck
];

const passedChecks = allChecks.filter(Boolean).length;
const totalChecks = allChecks.length;
const percentage = Math.round((passedChecks / totalChecks) * 100);

console.log(`  Verifica√ß√µes passadas: ${passedChecks}/${totalChecks} (${percentage}%)`);
console.log('');

if (percentage === 100) {
  console.log('  üéâ SISTEMA 100% CORRETO!');
  console.log('  ‚úÖ Marketplace e Boosting usam o MESMO fluxo');
  console.log('  ‚úÖ Mediador ser√° creditado em ambos os sistemas');
  console.log('');
  console.log('  üìã Pr√≥ximos passos:');
  console.log('    1. pm2 restart ZenithChat');
  console.log('    2. Confirmar entrega de boosting');
  console.log('    3. Verificar saldo do mediador aumentou');
} else {
  console.log('  ‚ö†Ô∏è SISTEMA PRECISA DE AJUSTES');
  console.log('  Revise os problemas listados acima');
}

console.log('\n' + '='.repeat(80));
console.log('‚úÖ An√°lise completa conclu√≠da!\n');
